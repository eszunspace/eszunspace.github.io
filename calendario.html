<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Calendario – EsZunSpace</title>
  <meta name="description" content="Calendario de lanzamientos de EsZunSpace: fechas, vehículos y transmisiones.">
  <link rel="canonical" href="https://eszunspace.es/calendario.html">
  <meta name="theme-color" content="#0b0b0f">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Space+Grotesk:wght@600;700&display=swap" rel="stylesheet">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <style>
    :root{
      --glass1: rgba(255,255,255,.07);
      --glass2: rgba(255,255,255,.03);
      --stroke: rgba(255,255,255,.12);
      --fg: #fff;
      --muted: rgba(255,255,255,.72);
      --accent1:#00f0ff; --accent2:#ff00d4;
      --tile: #141416;
      --tile-border: rgba(255,255,255,.12);
      --danger: #ff6b6b;
      --safe-touch: 44px; /* tamaño recomendado de objetivo táctil */
    }
    *{box-sizing:border-box}
    html,body{margin:0}
    body{ background:#0b0b0c; color:var(--fg); font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial; opacity:0; transition:opacity .4s ease; }
    body.fade-in{opacity:1}

    /* ===== NAV ===== */
    header.topbar{ position:sticky; top:0; left:0; right:0; z-index:1000; padding:10px 12px; background:linear-gradient(180deg, rgba(0,0,0,.65) 0%, rgba(0,0,0,0) 100%); backdrop-filter: blur(2px); }
    .nav-shell{ width:min(1200px, 94vw); margin:0 auto; min-height:56px; padding:0 12px; display:flex; align-items:center; justify-content:space-between; border-radius:14px; background:linear-gradient(180deg,var(--glass1),var(--glass2)); border:1px solid var(--stroke); box-shadow:0 10px 30px rgba(0,0,0,.6); position:relative; overflow:hidden; }
    .nav-shell::before{ content:""; position:absolute; inset:-1px; background:conic-gradient(from 0deg, var(--accent1), var(--accent2), var(--accent1)); filter:blur(22px); opacity:.14; pointer-events:none; }
    .brand{display:flex; align-items:center; gap:8px; text-decoration:none; color:#fff;}
    .brand .title{font-family:'Space Grotesk',system-ui,sans-serif; font-weight:800; letter-spacing:.02em; font-size:18px}
    .menu{display:flex; align-items:center; gap:12px}
    .menu a{ position:relative; display:inline-flex; align-items:center; padding:10px 8px; text-decoration:none; color:#fff; font-weight:700; text-transform:uppercase; letter-spacing:.08em; font-size:11px; opacity:.9; transition:opacity .2s ease; }
    .menu a:hover{opacity:1}
    .menu a::after{ content:""; position:absolute; left:10px; right:10px; bottom:6px; height:2px; background:linear-gradient(90deg, var(--accent1), var(--accent2)); transform:scaleX(0); transform-origin:left; transition:transform .25s ease; border-radius:2px; }
    .menu a:hover::after{transform:scaleX(1)}
    .menu a[aria-current="page"]{opacity:1}
    .menu a[aria-current="page"]::after{transform:scaleX(1)}

    .user-section{display:flex; align-items:center; gap:8px;}
    .user-info{ display:flex; align-items:center; gap:8px; padding:6px 10px; border-radius:10px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.18); }
    .user-avatar{ width:28px; height:28px; border-radius:50%; background:linear-gradient(135deg, var(--accent1), var(--accent2)); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:12px; }
    .user-name{font-weight:600; font-size:13px;}

    /* Hamburger (3 barras) */
    .hamburger{display:none; flex-direction:column; justify-content:center; align-items:center; width:36px; height:36px; border-radius:8px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.18); cursor:pointer;}
    .hamburger span{width:18px; height:2px; background:#fff; margin:3px 0; border-radius:1px; transition:all .3s ease;}
    .mobile-menu{display:none; flex-direction:column; background:#111; position:absolute; top:calc(100% + 8px); right:12px; left:12px; border-radius:10px; border:1px solid var(--stroke); overflow:hidden; box-shadow:0 8px 30px rgba(0,0,0,.5);}
    .mobile-menu a{padding:14px; text-align:center; color:#fff; text-decoration:none; border-bottom:1px solid rgba(255,255,255,.1); font-weight:700; text-transform:uppercase; letter-spacing:.06em; font-size:12px;}
    .mobile-menu a:last-child{border-bottom:none;}
    .mobile-menu.show{display:flex; animation:fadeIn .2s ease forwards;}
    @keyframes fadeIn{from{opacity:0; transform:translateY(-6px);} to{opacity:1; transform:none;}}

    /* ===== LAYOUT ===== */
    main{max-width:1200px; width:92vw; margin:20px auto 64px}
    .cal-header{ display:flex; align-items:center; justify-content:space-between; margin:8px 0 12px; gap:10px; flex-wrap:wrap; }
    .cal-title{ display:flex; align-items:center; gap:12px; font-family:'Space Grotesk',system-ui,sans-serif; text-transform:uppercase; letter-spacing:.04em; }
    .cal-title h1{margin:0; font-size:clamp(20px,3.6vw,28px)}

    .controls{ display:flex; align-items:center; gap:8px; background:linear-gradient(180deg,var(--glass1),var(--glass2)); border:1px solid var(--stroke); border-radius:12px; padding:6px; box-shadow:0 10px 24px rgba(0,0,0,.35); }
    .btn{ display:inline-flex; align-items:center; justify-content:center; height:36px; min-width:36px; padding:0 12px; border-radius:10px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.18); color:var(--fg); cursor:pointer; user-select:none; transition:transform .12s ease, background .2s ease, border-color .2s ease, opacity .2s ease; text-decoration:none; gap:8px; }
    .btn:active{transform:translateY(1px)}
    .btn.primary{ border:0; background: linear-gradient(90deg, var(--accent1), var(--accent2)); font-weight:700; box-shadow:0 8px 24px rgba(0,0,0,.35); }
    .btn.ghost{ background:rgba(255,255,255,.06); }
    .btn.danger{ background:rgba(255, 107, 107, .14); border-color: rgba(255,107,107,.45); }

    .month-pill{ font-weight:800; padding:8px 12px; border-radius:10px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.18); letter-spacing:.03em; font-size:14px }

    .weekday-row{ display:grid; grid-template-columns:repeat(7,1fr); gap:10px; margin:12px 0 6px; padding:0 2px; color:var(--muted); font-weight:700; text-transform:uppercase; letter-spacing:.08em; font-size:11px; }
    .grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:10px; }
    .day{ min-height:108px; border-radius:14px; background:#121214; border:1px solid var(--tile-border); position:relative; overflow:hidden; box-shadow:0 6px 16px rgba(0,0,0,.35); transition:box-shadow .2s ease, border-color .2s ease; }
    .day .num{ position:absolute; top:8px; left:8px; min-width:26px; height:26px; padding:0 8px; display:inline-flex; align-items:center; justify-content:center; font-size:12px; font-weight:800; color:#dfefff; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.22); border-radius:999px; }
    .day.today{ box-shadow:0 0 0 2px rgba(0,240,255,.25) inset, 0 10px 26px rgba(0,0,0,.5); border-color:rgba(0,240,255,.35); }
    .day .events{ position:absolute; inset:38px 8px 8px 8px; display:flex; flex-direction:column; gap:6px; }

    .event-mini-card{ position:relative; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px; padding:10px 8px; border-radius:12px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.12); }
    .event-mini-title{ font-weight:700; font-size:13px; text-align:center; line-height:1.15 }
    .event-mini-eta{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-variant-numeric: tabular-nums; font-size: 12px; opacity: .85; }
    .event-delete{ position:absolute; top:6px; right:6px; display:none; }
    .event-mini-card.admin .event-delete{ display:inline-flex; }

    /* ===== MOBILE-PRIMER ===== */
    @media (max-width: 820px){
      .menu{display:none}
      .nav-shell{width:96vw; border-radius:12px}
      .controls{ width:100%; justify-content:space-between; padding:6px; }
      .btn{ height:var(--safe-touch); min-width:var(--safe-touch); border-radius:12px; }
      .month-pill{ font-size:15px }
      .weekday-row{ gap:8px; font-size:10px }
      .grid{ gap:8px }
      .day{ min-height:96px; border-radius:12px }
      .event-mini-card{ padding:8px 6px; border-radius:10px }
      .hamburger{display:flex}
    }

    /* Extra small phones */
    @media (max-width: 420px){
      .brand .title{font-size:16px}
      .cal-title h1{font-size:18px}
      .controls{gap:6px}
      .month-pill{padding:8px 10px}
      .weekday-row{gap:6px}
      .grid{gap:6px}
      .day{min-height:88px}
      .event-mini-title{font-size:12px}
    }

    /* ===== Modales: móvil mejorado (scroll, sticky header/acciones) ===== */
    .modal-overlay{ position: fixed; inset: 0; background: rgba(0,0,0,.65); display: none; align-items: center; justify-content: center; z-index: 9999; padding: 12px; overflow:auto; }
    .modal-overlay.show{ display:flex; }
    .modal-card{ width:min(680px, 100%); max-height:92vh; border-radius:16px; background: radial-gradient(1200px 1200px at -10% -20%, rgba(0,240,255,.08), transparent 35%) , #111113; border:1px solid rgba(255,255,255,.12); box-shadow: 0 28px 80px rgba(0,0,0,.6), inset 0 1px 0 rgba(255,255,255,.06); padding:16px; overflow:auto; -webkit-overflow-scrolling:touch; overscroll-behavior:contain; }
    .modal-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; position:sticky; top:0; background:inherit; backdrop-filter:saturate(1.2) blur(6px); margin:-16px -16px 0; padding:12px 16px; border-bottom:1px solid rgba(255,255,255,.08); z-index:2; }
    .modal-title{ margin:0; font-family:'Space Grotesk', system-ui, sans-serif; font-size:1.08rem; letter-spacing:.2px; font-weight:700; }
    .goal-pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:12px; margin-top:12px; background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03)); border:1px solid rgba(255,255,255,.12); font-size:.92rem; }
    .goal-dot{ width:8px; height:8px; border-radius:50%; background:linear-gradient(90deg,var(--accent1),var(--accent2)); }
    .countdown-hero{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-variant-numeric: tabular-nums; margin: 12px 0 6px; font-size: clamp(26px, 6vw, 40px); font-weight: 700; letter-spacing: .5px; }
    .modal-desc{ color:var(--muted); line-height:1.45; margin:8px 0 14px; }
    .timezone-note{ color:var(--muted); opacity:.85; margin-top:6px; font-size:.95rem; }
    .modal-actions{ display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; position:sticky; bottom:0; background:linear-gradient(180deg, rgba(17,17,19,.2), rgba(17,17,19,.9)); margin:12px -16px -16px; padding:12px 16px calc(12px + env(safe-area-inset-bottom)); border-top:1px solid rgba(255,255,255,.1); z-index:2; }

    .modal-info{ display:grid; gap:6px; margin:12px 0 10px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.1); border-radius:12px; padding:12px 14px; }

    .form-grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px; }
    .form-grid .full{ grid-column:1/-1; }
    .form-group{ display:flex; flex-direction:column; gap:6px; }
    .form-group label{ font-weight:600; font-size:14px; }
    .form-group input, .form-group textarea{ padding:12px; border-radius:10px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.18); color:var(--fg); font-size:15px; font-family:inherit; }
    .form-group textarea{ min-height:96px; resize:vertical; }
    .help{ color:var(--muted); font-size:12px; }

    @media (max-width:720px){ .form-grid{ grid-template-columns:1fr; } }
    @media (max-width:600px){
      .modal-overlay{ align-items:flex-end; padding:0; }
      .modal-card{ width:100%; max-width:none; max-height:92vh; border-radius:16px 16px 0 0; }
    }

    @media (prefers-reduced-motion: reduce){
      *{transition:none !important;}
      .nav-shell::before{display:none}
    }
  </style>

  <link rel="icon" type="image/jpeg" href="logoarriba.jpg">
  <link rel="apple-touch-icon" href="logoarriba.jpg">
  <link rel="shortcut icon" href="logoarriba.jpg" type="image/x-icon">
</head>
<body>
  <header class="topbar">
    <div class="nav-shell">
      <a class="brand" href="index.html" aria-label="Ir a inicio">
        <span class="title">EsZunSpace</span>
      </a>

      <!-- Menú desktop -->
      <nav class="menu" aria-label="Principal">
        <a href="calendario.html" aria-current="page">Calendario</a>
        <a href="cohetes.html">Cohetes</a>
        <a href="motores.html">Motores</a>
        <a href="satelites.html">Satélites</a>
        <a href="lanzamientos.html">Lanzamientos</a>
      </nav>

      <!-- Botón hamburguesa -->
      <button class="hamburger" id="hamburger" aria-label="Abrir menú" aria-expanded="false" aria-controls="mobileMenu">
        <span></span><span></span><span></span>
      </button>

      <!-- Usuario / login -->
      <div class="user-section">
        <div id="user-display" style="display:none;">
          <div class="user-info">
            <div class="user-avatar" id="user-avatar">U</div>
            <span class="user-name" id="user-name">Usuario</span>
          </div>
          <button class="btn ghost" onclick="logout()">Salir</button>
        </div>
        <button id="login-btn" class="btn primary" onclick="showLoginModal()">Iniciar sesión</button>
      </div>
    </div>

    <!-- Menú móvil desplegable -->
    <nav class="mobile-menu" id="mobileMenu" aria-label="Principal móvil">
      <a href="calendario.html">Calendario</a>
      <a href="cohetes.html">Cohetes</a>
      <a href="motores.html">Motores</a>
      <a href="satelites.html">Satélites</a>
      <a href="lanzamientos.html">Lanzamientos</a>
    </nav>
  </header>

  <main>
    <div class="cal-header">
      <div class="cal-title"><h1>Calendario de lanzamientos</h1></div>
      <div class="controls">
        <button class="btn" id="prev" aria-label="Mes anterior">◀</button>
        <span class="month-pill" id="monthLabel">octubre 2025</span>
        <button class="btn" id="next" aria-label="Mes siguiente">▶</button>
        <button class="btn primary" id="btn-add" style="display:none;">Añadir</button>
      </div>
    </div>

    <div class="weekday-row" aria-hidden="true">
      <div>Lun</div><div>Mar</div><div>Mié</div><div>Jue</div><div>Vie</div><div>Sáb</div><div>Dom</div>
    </div>

    <section class="grid" id="grid" role="grid" aria-label="Calendario mensual"></section>
  </main>

  <!-- ===== Modales ===== -->
  <div id="auth-modal-overlay" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card" role="document">
      <div class="modal-head">
        <h3 id="auth-modal-title" class="modal-title">Iniciar sesión</h3>
        <button class="btn ghost" onclick="closeAuthModal()" aria-label="Cerrar">✕</button>
      </div>

      <form id="login-form" class="login-form" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label for="login-username">Usuario</label>
          <input type="text" id="login-username" name="username" required autocomplete="username">
        </div>
        <div class="form-group">
          <label for="login-password">Contraseña</label>
          <input type="password" id="login-password" name="password" required autocomplete="current-password">
          <div id="login-error" class="error-msg" style="display:none">Usuario o contraseña incorrectos</div>
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn primary">Entrar</button>
          <button type="button" class="btn ghost" onclick="closeAuthModal()">Cancelar</button>
        </div>
        <div class="toggle-form">
          ¿No tienes cuenta? <a href="#" onclick="showRegisterForm(event)">Crear cuenta</a>
        </div>
      </form>

      <form id="register-form" class="login-form" style="display:none;" onsubmit="handleRegister(event)">
        <div class="form-group">
          <label for="register-username">Usuario</label>
          <input type="text" id="register-username" name="username" required autocomplete="username">
          <div id="register-username-error" class="error-msg" style="display:none">Este nombre de usuario ya está en uso</div>
        </div>
        <div class="form-group">
          <label for="register-password">Contraseña</label>
          <input type="password" id="register-password" name="password" required autocomplete="new-password" minlength="6">
          <div id="register-error" class="error-msg" style="display:none">Error al crear la cuenta</div>
          <div id="register-success" class="success-msg" style="display:none">¡Cuenta creada! Iniciando sesión...</div>
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn primary">Crear cuenta</button>
          <button type="button" class="btn ghost" onclick="closeAuthModal()">Cancelar</button>
        </div>
        <div class="toggle-form">
          ¿Ya tienes cuenta? <a href="#" onclick="showLoginForm(event)">Iniciar sesión</a>
        </div>
      </form>
    </div>
  </div>

  <div id="event-modal-overlay" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card" role="document">
      <div class="modal-head">
        <h3 id="modal-title" class="modal-title">Cohete – Lanzamiento</h3>
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="btn-delete-event" class="btn danger" style="display:none;">Eliminar</button>
          <button class="btn ghost" onclick="closeEventModal()" aria-label="Cerrar">Cerrar</button>
        </div>
      </div>

      <div id="modal-goal" class="goal-pill">
        <span class="goal-dot"></span>
        Ventana objetivo: —
      </div>

      <div class="countdown-hero"><span id="modal-countdown" data-countdown-dt=""></span></div>

      <div id="modal-info" class="modal-info"></div>
      <div id="modal-desc" class="modal-desc"></div>

      <div class="timezone-note">La cuenta atrás se basa en la hora de <strong>Europa/Madrid</strong>.</div>

      <div class="modal-actions">
        <a id="modal-watch" class="btn primary" href="#" target="_blank" rel="noopener noreferrer">Ver transmisión</a>
        <button class="btn ghost" onclick="closeEventModal()">Cerrar</button>
      </div>
    </div>
  </div>

  <div id="editor-modal-overlay" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card" role="document">
      <div class="modal-head">
        <h3 id="editor-modal-title" class="modal-title">Nuevo lanzamiento</h3>
        <button class="btn ghost" onclick="closeEditorModal()" aria-label="Cerrar">✕</button>
      </div>

      <form id="event-form" onsubmit="submitEventForm(event)">
        <div class="form-grid">
          <div class="form-group">
            <label for="ev-vehicle">Vehículo</label>
            <input id="ev-vehicle" required placeholder="Neutron, Falcon 9..." />
          </div>
          <div class="form-group">
            <label for="ev-title">Título</label>
            <input id="ev-title" required placeholder="Cohete X — Lanzamiento" />
          </div>
          <div class="form-group full">
            <label for="ev-datetime">Fecha y hora</label>
            <input id="ev-datetime" type="datetime-local" required />
            <div class="help">Se guardará con tu zona horaria (incluyendo offset).</div>
          </div>
          <div class="form-group full">
            <label for="ev-stream">URL de transmisión (opcional)</label>
            <input id="ev-stream" placeholder="https://..." />
          </div>
          <div class="form-group full">
            <label for="ev-description">Descripción corta</label>
            <textarea id="ev-description" placeholder="Resumen del lanzamiento"></textarea>
          </div>
          <div class="form-group">
            <label for="ev-mission">Misión</label>
            <input id="ev-mission" placeholder="Nombre de la misión" />
          </div>
          <div class="form-group">
            <label for="ev-site">Lugar</label>
            <input id="ev-site" placeholder="Plataforma, Centro, Ciudad, País" />
          </div>
          <div class="form-group">
            <label for="ev-vehicleFull">Vehículo (completo)</label>
            <input id="ev-vehicleFull" placeholder="Neutron (EsZunSpace)" />
          </div>
          <div class="form-group">
            <label for="ev-payload">Carga útil</label>
            <input id="ev-payload" placeholder="Nombre del satélite / carga" />
          </div>
          <div class="form-group full">
            <label for="ev-orbit">Órbita objetivo</label>
            <input id="ev-orbit" placeholder="LEO, GTO, 140x140 km..." />
          </div>
        </div>
        <div class="modal-actions" style="margin-top:10px;">
          <button type="submit" class="btn primary">Guardar</button>
          <button type="button" class="btn ghost" onclick="closeEditorModal()">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ===== CONFIGURACIÓN DE FIREBASE =====
    const firebaseConfig = {
      apiKey: "AIzaSyDKvGLsd1jKfsSlzgTjBas-8WvbFqV1xU",
      authDomain: "eszunspace-bc900.firebaseapp.com",
      databaseURL: "https://eszunspace-bc900-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "eszunspace-bc900",
      storageBucket: "eszunspace-bc900.firebasestorage.app",
      messagingSenderId: "105651684829",
      appId: "1:105651684829:web:5c8fd5051c8c2daf24f744",
      measurementId: "G-ZDM5GF0MBW"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // ====== AUTH BÁSICA ======
    let currentUser = null;
    const SESSION_KEY = 'esz_user';
    const ADMIN_USERS = ['Esstor','ZundakyGC'];

    function isAdmin(){ return currentUser && ADMIN_USERS.includes(currentUser); }

    function hydrateSessionFromStorage(){
      const saved = localStorage.getItem(SESSION_KEY);
      currentUser = (saved && saved.trim()) ? saved : null;
      checkAuth();
    }

    window.addEventListener('storage', (e) => { if (e.key === SESSION_KEY) hydrateSessionFromStorage(); });

    let allUsers = {};

    async function loadUsers() {
      try {
        const snapshot = await database.ref('users').once('value');
        allUsers = snapshot.val() || {};
      } catch (error) {
        console.error('Error al cargar usuarios:', error);
        allUsers = {};
      }
    }

    async function saveUser(username, password) {
      try {
        const snapshot = await database.ref('users/' + username).once('value');
        if (snapshot.exists()) return false;
        await database.ref('users/' + username).set(password);
        allUsers[username] = password;
        return true;
      } catch (error) {
        console.error('Error al guardar usuario:', error);
        return false;
      }
    }

    function checkAuth() {
      document.getElementById('login-btn').style.display = currentUser ? 'none' : 'inline-flex';
      document.getElementById('user-display').style.display = currentUser ? 'flex' : 'none';
      if (currentUser){
        document.getElementById('user-name').textContent = currentUser;
        document.getElementById('user-avatar').textContent = currentUser.charAt(0).toUpperCase();
      }
      document.getElementById('btn-add').style.display = isAdmin() ? 'inline-flex' : 'none';
      render(); // re-render para mostrar controles admin
    }

    function showLoginModal() { showLoginForm(); document.getElementById('auth-modal-overlay').classList.add('show'); }
    function closeAuthModal() {
      document.getElementById('auth-modal-overlay').classList.remove('show');
      ['login-error','register-error','register-username-error','register-success'].forEach(id=>document.getElementById(id)?.classList.remove('show'));
    }
    function showLoginForm(e){ if(e) e.preventDefault(); document.getElementById('auth-modal-title').textContent='Iniciar sesión'; document.getElementById('login-form').style.display='flex'; document.getElementById('register-form').style.display='none'; document.getElementById('login-username').value=''; document.getElementById('login-password').value=''; const le=document.getElementById('login-error'); if(le) le.style.display='none'; }
    function showRegisterForm(e){ if(e) e.preventDefault(); document.getElementById('auth-modal-title').textContent='Crear cuenta'; document.getElementById('login-form').style.display='none'; document.getElementById('register-form').style.display='flex'; document.getElementById('register-username').value=''; document.getElementById('register-password').value=''; ['register-error','register-username-error','register-success'].forEach(id=>{const el=document.getElementById(id); if(el) el.style.display='none';}); }

    async function handleLogin(e){ e.preventDefault(); const username=document.getElementById('login-username').value.trim(); const password=document.getElementById('login-password').value; const le=document.getElementById('login-error'); if (allUsers[username] && allUsers[username]===password){ currentUser=username; localStorage.setItem(SESSION_KEY,currentUser); checkAuth(); closeAuthModal(); } else { if(le) le.style.display='block'; } }
    async function handleRegister(e){ e.preventDefault(); const username=document.getElementById('register-username').value.trim(); const password=document.getElementById('register-password').value; ['register-error','register-username-error','register-success'].forEach(id=>{const el=document.getElementById(id); if(el) el.style.display='none';}); if (allUsers[username]){ const ue=document.getElementById('register-username-error'); if(ue) ue.style.display='block'; return; } const saved=await saveUser(username,password); if (saved){ const rs=document.getElementById('register-success'); if(rs) rs.style.display='block'; setTimeout(()=>{ currentUser=username; localStorage.setItem(SESSION_KEY,currentUser); checkAuth(); closeAuthModal(); }, 1000); } else { const re=document.getElementById('register-error'); if(re) re.style.display='block'; } }
    function logout(){ currentUser=null; localStorage.removeItem(SESSION_KEY); checkAuth(); }

    document.addEventListener("DOMContentLoaded", async () => {
      document.body.classList.add("fade-in");
      await loadUsers();
      hydrateSessionFromStorage();
      await loadEvents();
      startCountdowns();

      // Toggle menú móvil + autocierre al elegir opción
      const hamburger = document.getElementById('hamburger');
      const mobileMenu = document.getElementById('mobileMenu');
      const toggleMenu = () => {
        const open = !mobileMenu.classList.contains('show');
        mobileMenu.classList.toggle('show', open);
        hamburger.setAttribute('aria-expanded', String(open));
      };
      hamburger.addEventListener('click', toggleMenu);
      mobileMenu.querySelectorAll('a').forEach(a => a.addEventListener('click', () => {
        mobileMenu.classList.remove('show');
        hamburger.setAttribute('aria-expanded', 'false');
      }));
      // Cerrar al tocar fuera
      document.addEventListener('click', (e)=>{
        if (!mobileMenu.classList.contains('show')) return;
        const within = e.target.closest('#mobileMenu') || e.target.closest('#hamburger');
        if (!within){
          mobileMenu.classList.remove('show');
          hamburger.setAttribute('aria-expanded', 'false');
        }
      });
    });

    // ====== CALENDARIO ======
    const monthLabel = document.getElementById('monthLabel');
    const grid = document.getElementById('grid');
    const btnPrev = document.getElementById('prev');
    const btnNext = document.getElementById('next');
    const btnAdd  = document.getElementById('btn-add');

    btnPrev.addEventListener('click', ()=>{ current.setMonth(current.getMonth()-1); render(); startCountdowns(); });
    btnNext.addEventListener('click', ()=>{ current.setMonth(current.getMonth()+1); render(); startCountdowns(); });
    btnAdd.addEventListener('click', ()=>{ if(isAdmin()) openEditorModal(); });

    let EVENTS = [];

    async function loadEvents(){
      try{
        const snap = await database.ref('events').once('value');
        const data = snap.val() || {};
        EVENTS = Object.values(data).sort((a,b)=> new Date(a.datetimeISO)-new Date(b.datetimeISO));
        render();
      }catch(err){ console.error('Error cargando eventos', err); }
    }

    function sameDay(a, b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
    function startCountdowns(){
      const nodes=document.querySelectorAll('[data-countdown-dt]');
      function fmt(diffMs){
        if(diffMs<=0){
          const sec=Math.abs(Math.floor(diffMs/1000));
          const d=Math.floor(sec/86400);
          const h=Math.floor((sec%86400)/3600);
          const m=Math.floor((sec%3600)/60);
          const s=sec%60;
          return `T+ ${d>0? d+'d':'0d'} ${String(h).padStart(2,'0')}h ${String(m).padStart(2,'0')}m ${String(s).padStart(2,'0')}s`;
        }
        const sec=Math.floor(diffMs/1000);
        const d=Math.floor(sec/86400);
        const h=Math.floor((sec%86400)/3600);
        const m=Math.floor((sec%3600)/60);
        const s=sec%60;
        return `T- ${d>0? d+'d':'0d'} ${String(h).padStart(2,'0')}h ${String(m).padStart(2,'0')}m ${String(s).padStart(2,'0')}s`;
      }
      function tick(){
        const now=new Date();
        nodes.forEach(el=>{
          const target=new Date(el.getAttribute('data-countdown-dt'));
          el.textContent=fmt(target-now);
        });
      }
      tick();
      clearInterval(window.__countdownInterval);
      window.__countdownInterval=setInterval(tick,1000);
    }

    let current = new Date(); current.setDate(1);
    const MES = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
    function firstDayMondayIndex(date){ const d=new Date(date); return (d.getDay()+6)%7; }
    function daysInMonth(date){ return new Date(date.getFullYear(), date.getMonth()+1, 0).getDate(); }
    function isToday(d){ const t=new Date(); return d.getFullYear()===t.getFullYear() && d.getMonth()===t.getMonth() && d.getDate()===t.getDate(); }

    function render(){
      if(!monthLabel) return;
      const year = current.getFullYear();
      const month = current.getMonth();
      monthLabel.textContent = `${MES[month]} ${year}`;

      grid.innerHTML = '';
      const firstIdx = firstDayMondayIndex(current);
      const total = daysInMonth(current);

      for(let i=0;i<firstIdx;i++){ const cell=document.createElement('div'); cell.className='day'; grid.appendChild(cell); }

      for(let day=1; day<=total; day++){
        const cell = document.createElement('div');
        cell.className = 'day';
        const date = new Date(year, month, day);
        if(isToday(date)) cell.classList.add('today');

        const num = document.createElement('span');
        num.className = 'num'; num.textContent = day;

        const events = document.createElement('div');
        events.className = 'events';

        const todaysEvents = EVENTS.filter(ev => sameDay(new Date(ev.datetimeISO), new Date(year, month, day)));

        todaysEvents.forEach(ev => {
          const card = document.createElement('div');
          card.className = 'event-mini-card' + (isAdmin()? ' admin' : '');
          card.addEventListener('click', (e)=>{ if(e.target.closest('.event-delete')) return; openEventModal(ev); });

          const title = document.createElement('div');
          title.className = 'event-mini-title';
          title.textContent = ev.vehicle || 'Lanzamiento';

          const countdown = document.createElement('div');
          countdown.className = 'event-mini-eta';
          countdown.setAttribute('data-countdown-dt', ev.datetimeISO);

          if (isAdmin()){
            const del = document.createElement('button');
            del.className = 'btn danger event-delete';
            del.textContent = '✕';
            del.title = 'Eliminar lanzamiento';
            del.addEventListener('click', async (e)=>{ e.stopPropagation(); await deleteEvent(ev.id); });
            card.appendChild(del);
          }

          card.appendChild(title);
          card.appendChild(countdown);
          events.appendChild(card);
        });

        cell.appendChild(num);
        cell.appendChild(events);
        grid.appendChild(cell);
      }
    }

    function capitalizarPrimera(s){ return s ? s.charAt(0).toUpperCase() + s.slice(1) : s; }
    function formatGoalWindow(dtISO){ const dt = new Date(dtISO); const opts = { weekday:'long', day:'numeric', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit' }; const s = dt.toLocaleString('es-ES', opts); return s.replace(/^\w/, c=>c.toLowerCase()); }
    function formatLongDate(dtISO){ const dt = new Date(dtISO); const opts = { weekday:'long', day:'numeric', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit' }; let s = dt.toLocaleString('es-ES', opts); s = s.replace(/^\w/, c=>c.toLowerCase()); return capitalizarPrimera(s); }

    let __currentModalEvent = null;
    function openEventModal(ev){
      __currentModalEvent = ev;
      const overlay = document.getElementById('event-modal-overlay');
      const title = document.getElementById('modal-title');
      const goal = document.getElementById('modal-goal');
      const countdown = document.getElementById('modal-countdown');
      const info = document.getElementById('modal-info');
      const desc = document.getElementById('modal-desc');
      const watch = document.getElementById('modal-watch');
      const btnDel = document.getElementById('btn-delete-event');

      title.textContent = ev.title || 'Evento';
      goal.innerHTML = `<span class="goal-dot"></span> Ventana objetivo: ${formatGoalWindow(ev.datetimeISO)} (España)`;
      countdown.setAttribute('data-countdown-dt', ev.datetimeISO);

      if (ev.mission || ev.site || ev.vehicleFull || ev.payload || ev.orbit){
        const fecha = `${formatLongDate(ev.datetimeISO)} (hora de España)`;
        info.innerHTML = `
          <div><b>Misión:</b> ${ev.mission || '—'}</div>
          <div><b>Fecha de lanzamiento:</b> ${fecha}</div>
          <div><b>Lugar:</b> ${ev.site || '—'}</div>
          <div><b>Vehículo:</b> ${ev.vehicleFull || ev.vehicle || '—'}</div>
          <div><b>Carga útil:</b> ${ev.payload || '—'}</div>
          <div><b>Órbita objetivo:</b> ${ev.orbit || '—'}</div>
        `;
        info.style.display = 'grid';
        desc.textContent = '';
      } else {
        info.style.display = 'none';
        desc.textContent = ev.description || '';
      }

      if (ev.streamUrl) { watch.href = ev.streamUrl; watch.style.display='inline-flex'; }
      else { watch.style.display='none'; }

      btnDel.style.display = isAdmin() ? 'inline-flex' : 'none';
      btnDel.onclick = async ()=>{ if(!__currentModalEvent) return; await deleteEvent(__currentModalEvent.id); closeEventModal(); };

      overlay.classList.add('show');
      overlay.setAttribute('aria-hidden','false');
      startCountdowns();
    }
    function closeEventModal(){ const overlay = document.getElementById('event-modal-overlay'); overlay.classList.remove('show'); overlay.setAttribute('aria-hidden','true'); __currentModalEvent = null; }

    // ====== EDITOR ======
    function openEditorModal(){
      const overlay = document.getElementById('editor-modal-overlay');
      overlay.classList.add('show');
      document.getElementById('editor-modal-title').textContent='Nuevo lanzamiento';
      document.getElementById('event-form').reset();
      // Bloquear scroll del fondo y foco al primer campo
      document.documentElement.style.overflow='hidden';
      document.body.style.overflow='hidden';
      setTimeout(()=>{ document.getElementById('ev-vehicle')?.focus(); }, 80);
    }
    function closeEditorModal(){
      const overlay = document.getElementById('editor-modal-overlay');
      overlay.classList.remove('show');
      // Restaurar scroll del fondo
      document.documentElement.style.overflow='';
      document.body.style.overflow='';
    }

    function makeIdFrom(title, dt){
      const slug = (title||'lanzamiento').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
      const d = new Date(dt);
      const yyyy=d.getFullYear(); const mm=String(d.getMonth()+1).padStart(2,'0'); const dd=String(d.getDate()).padStart(2,'0');
      return `${slug}-${yyyy}-${mm}-${dd}`;
    }

    function localDatetimeToISOWithTZ(localValue){
      const dt = new Date(localValue);
      const tzOffsetMin = -dt.getTimezoneOffset();
      const sign = tzOffsetMin >= 0 ? '+' : '-';
      const hh = String(Math.floor(Math.abs(tzOffsetMin)/60)).padStart(2,'0');
      const mm = String(Math.abs(tzOffsetMin)%60).padStart(2,'0');
      const yyyy = dt.getFullYear(); const M = String(dt.getMonth()+1).padStart(2,'0'); const d = String(dt.getDate()).padStart(2,'0'); const H = String(dt.getHours()).padStart(2,'0'); const m = String(dt.getMinutes()).padStart(2,'0');
      return `${yyyy}-${M}-${d}T${H}:${m}:00${sign}${hh}:${mm}`;
    }

    async function submitEventForm(e){
      e.preventDefault();
      if(!isAdmin()) return alert('No tienes permisos para crear lanzamientos.');
      const vehicle = document.getElementById('ev-vehicle').value.trim();
      const title = document.getElementById('ev-title').value.trim();
      const dtLocal = document.getElementById('ev-datetime').value;
      const datetimeISO = localDatetimeToISOWithTZ(dtLocal);
      const streamUrl = document.getElementById('ev-stream').value.trim();
      const description = document.getElementById('ev-description').value.trim();
      const mission = document.getElementById('ev-mission').value.trim();
      const site = document.getElementById('ev-site').value.trim();
      const vehicleFull = document.getElementById('ev-vehicleFull').value.trim();
      const payload = document.getElementById('ev-payload').value.trim();
      const orbit = document.getElementById('ev-orbit').value.trim();

      const id = makeIdFrom(title || vehicle, datetimeISO);
      const eventObj = { id, title, vehicle, datetimeISO, streamUrl: streamUrl || null, description, mission, site, vehicleFull, payload, orbit };

      try{
        await database.ref('events/'+id).set(eventObj);
        await loadEvents();
        closeEditorModal();
      }catch(err){
        console.error('Error guardando evento', err);
        alert('No se pudo guardar el lanzamiento.');
      }
    }

    async function deleteEvent(id){
      if(!isAdmin()) return alert('No tienes permisos para eliminar lanzamientos.');
      if(!confirm('¿Eliminar este lanzamiento? Esta acción no se puede deshacer.')) return;
      try{
        await database.ref('events/'+id).remove();
        await loadEvents();
      }catch(err){
        console.error('Error eliminando evento', err);
        alert('No se pudo eliminar el lanzamiento.');
      }
    }
  </script>

  <!-- Nota: se ha simplificado el bloque anti-inspección para evitar recargas inesperadas en móviles. Si quieres, lo reactivamos. -->
</body>
</html>
