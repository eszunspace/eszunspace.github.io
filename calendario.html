<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EsZunSpace – Calendario</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Space+Grotesk:wght@600;700&display=swap" rel="stylesheet">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  
  <style>
    :root{
      --glass1: rgba(255,255,255,.07);
      --glass2: rgba(255,255,255,.03);
      --stroke: rgba(255,255,255,.12);
      --fg: #fff;
      --muted: rgba(255,255,255,.72);
      --accent1:#00f0ff; --accent2:#ff00d4;
      --tile: #141416;
      --tile-border: rgba(255,255,255,.12);
    }
    *{box-sizing:border-box}
    html,body{margin:0}
    body{
      background:#0b0b0c; color:var(--fg);
      font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial;
      opacity:0; transition:opacity .6s ease;
    }
    body.fade-in{opacity:1} body.fade-out{opacity:0}

    header.topbar{
      position:sticky; top:0; left:0; right:0; z-index:1000;
      padding:14px 16px;
      background:linear-gradient(180deg, rgba(0,0,0,.65) 0%, rgba(0,0,0,0) 100%);
      backdrop-filter: blur(2px);
    }
    .nav-shell{
      width:min(1200px, 94vw);
      margin:0 auto;
      height:60px; padding:0 18px;
      display:flex; align-items:center; justify-content:space-between;
      border-radius:18px;
      background:linear-gradient(180deg,var(--glass1),var(--glass2));
      border:1px solid var(--stroke);
      box-shadow:0 10px 30px rgba(0,0,0,.6);
      position:relative; overflow:hidden;
    }
    .nav-shell::before{
      content:""; position:absolute; inset:-1px;
      background:conic-gradient(from 0deg, var(--accent1), var(--accent2), var(--accent1));
      filter:blur(22px); opacity:.14; pointer-events:none;
    }
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:#fff;}
    .brand .title{font-family:'Space Grotesk',system-ui,sans-serif; font-weight:800; letter-spacing:.02em;}
    .menu{display:flex; align-items:center; gap:18px}
    .menu a{
      position:relative; display:inline-flex; align-items:center;
      padding:10px 10px; text-decoration:none; color:#fff;
      font-weight:700; text-transform:uppercase; letter-spacing:.08em; font-size:12px; opacity:.9;
      transition:opacity .2s ease;
    }
    .menu a:hover{opacity:1}
    .menu a::after{
      content:""; position:absolute; left:12px; right:12px; bottom:6px; height:2px;
      background:linear-gradient(90deg, var(--accent1), var(--accent2));
      transform:scaleX(0); transform-origin:left; transition:transform .25s ease; border-radius:2px;
    }
    .menu a:hover::after{transform:scaleX(1)}
    .menu a[aria-current="page"]{opacity:1}
    .menu a[aria-current="page"]::after{transform:scaleX(1)}

    .user-section{display:flex; align-items:center; gap:10px;}
    .user-info{
      display:flex; align-items:center; gap:8px;
      padding:6px 12px; border-radius:10px;
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.18);
    }
    .user-avatar{
      width:28px; height:28px; border-radius:50%;
      background:linear-gradient(135deg, var(--accent1), var(--accent2));
      display:flex; align-items:center; justify-content:center;
      font-weight:700; font-size:12px;
    }
    .user-name{font-weight:600; font-size:13px;}

    main{max-width:1200px; width:92vw; margin:28px auto 64px}
    .cal-header{
      display:flex; align-items:center; justify-content:space-between;
      margin:10px 0 16px;
    }
    .cal-title{ display:flex; align-items:center; gap:14px; font-family:'Space Grotesk',system-ui,sans-serif; text-transform:uppercase; letter-spacing:.04em; }
    .cal-title h1{margin:0; font-size:clamp(22px,3.4vw,28px)}
    .controls{
      display:flex; align-items:center; gap:8px;
      background:linear-gradient(180deg,var(--glass1),var(--glass2));
      border:1px solid var(--stroke); border-radius:14px;
      padding:6px 8px; box-shadow:0 10px 24px rgba(0,0,0,.35);
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      height:32px; min-width:32px; padding:0 10px; border-radius:10px;
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.18);
      color:var(--fg); cursor:pointer; user-select:none;
      transition:transform .15s ease, background .2s ease, border-color .2s ease, opacity .2s ease;
      text-decoration:none;
      gap:8px;
    }
    .btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.1); border-color:rgba(255,255,255,.3)}
    .btn.primary{
      border:0;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      font-weight:700;
      box-shadow:0 8px 24px rgba(0,0,0,.35);
    }
    .btn.ghost{ background:rgba(255,255,255,.06); }

    .month-pill{
      font-weight:800; padding:8px 12px; border-radius:10px;
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.18);
      letter-spacing:.03em;
    }

    .weekday-row{
      display:grid; grid-template-columns:repeat(7,1fr); gap:14px; margin:18px 0 8px; padding:0 4px;
      color:var(--muted); font-weight:700; text-transform:uppercase; letter-spacing:.08em; font-size:12px;
    }
    .grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:14px; }
    .day{
      height:120px; border-radius:16px; background:#121214;
      border:1px solid var(--tile-border); position:relative; overflow:hidden;
      box-shadow:0 6px 16px rgba(0,0,0,.35);
      transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease;
      cursor: default;
    }
    .day:hover{ transform:translateY(-2px); box-shadow:0 12px 26px rgba(0,0,0,.5); border-color:rgba(255,255,255,.22); }
    .day .num{
      position:absolute; top:8px; left:8px;
      min-width:26px; height:26px; padding:0 8px; display:inline-flex; align-items:center; justify-content:center;
      font-size:12px; font-weight:800; color:#dfefff;
      background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.22); border-radius:999px;
    }
    .day.today{
      outline:2px solid transparent;
      box-shadow:0 0 0 2px rgba(0,240,255,.25) inset, 0 10px 26px rgba(0,0,0,.5);
      border-color:rgba(0,240,255,.35);
    }
    .day .events{ position:absolute; inset:38px 10px 10px 10px; display:flex; flex-direction:column; gap:6px; }

    .event-mini-card{
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:4px; padding:10px 8px;
      border-radius:12px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.12);
      cursor:pointer;
      transition:transform .15s ease, background .2s ease, border-color .2s ease;
    }
    .event-mini-card:hover{ transform:translateY(-1px); background:rgba(255,255,255,.08); border-color:rgba(255,255,255,.2); }
    .event-mini-title{ font-weight:700; font-size:13px; }
    .event-mini-eta{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-variant-numeric: tabular-nums;
      font-size: 12px; opacity: .85;
    }

    @media (max-width: 820px){
      .day{height:90px}
      .weekday-row{gap:10px}
      .grid{gap:10px}
      .menu{display:none;}
    }

    /* Modal */
    .modal-overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 18px;
    }
    .modal-overlay.show{ display:flex; }
    .modal-card{
      width:min(680px, 96vw);
      border-radius:18px;
      background: radial-gradient(1200px 1200px at -10% -20%, rgba(0,240,255,.08), transparent 35%) , #111113;
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 28px 80px rgba(0,0,0,.6), inset 0 1px 0 rgba(255,255,255,.06);
      padding:18px 18px 16px;
    }
    .modal-head{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .modal-title{ margin:0; font-family:'Space Grotesk', system-ui, sans-serif; font-size:1.15rem; letter-spacing:.2px; font-weight:700; }
    .goal-pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px; border-radius:12px; margin-top:12px;
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.12);
      font-size:.92rem;
    }
    .goal-dot{ width:8px; height:8px; border-radius:50%; background:linear-gradient(90deg,var(--accent1),var(--accent2)); }
    .countdown-hero{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-variant-numeric: tabular-nums;
      margin: 14px 0 8px;
      font-size: clamp(28px, 6vw, 40px);
      font-weight: 700;
      letter-spacing: .5px;
    }
    .modal-desc{ color:var(--muted); line-height:1.45; margin:10px 0 16px; }
    .timezone-note{ color:var(--muted); opacity:.85; margin-top:6px; font-size:.95rem; }
    .modal-actions{ display:flex; gap:10px; justify-content:flex-end; }

    .modal-info{
      display:grid; gap:6px; margin:12px 0 10px;
      background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.1);
      border-radius:12px; padding:12px 14px;
    }
    .modal-info b{ font-weight:700; }

    /* Login/Register Modal */
    .login-form{
      display:flex; flex-direction:column; gap:16px; margin-top:20px;
    }
    .form-group{display:flex; flex-direction:column; gap:6px;}
    .form-group label{font-weight:600; font-size:14px;}
    .form-group input{
      padding:12px 14px; border-radius:10px;
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.18);
      color:var(--fg); font-size:14px; font-family:inherit;
      transition:border-color .2s ease, background .2s ease;
    }
    .form-group input:focus{
      outline:none; border-color:var(--accent1);
      background:rgba(255,255,255,.08);
    }
    .error-msg{
      color:#ff6b6b; font-size:13px; margin-top:4px; display:none;
    }
    .error-msg.show{display:block;}
    .success-msg{
      color:#51cf66; font-size:13px; margin-top:4px; display:none;
    }
    .success-msg.show{display:block;}
    .toggle-form{
      text-align:center; margin-top:16px; color:var(--muted); font-size:14px;
    }
    .toggle-form a{
      color:var(--accent1); text-decoration:none; font-weight:600;
      transition:opacity .2s ease;
    }
    .toggle-form a:hover{opacity:.8}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="nav-shell">
      <a class="brand" href="index.html" aria-label="Ir a inicio">
        <span class="title">EsZunSpace</span>
      </a>
      <nav class="menu">
        <a href="calendario.html" aria-current="page">Calendario</a>
        <a href="cohetes.html">Cohetes</a>
        <a href="motores.html">Motores</a>
        <a href="satelites.html">Satélites</a>
        <a href="lanzamientos.html">Lanzamientos</a>
      </nav>
      <div class="user-section">
        <div id="user-display" style="display:none;">
          <div class="user-info">
            <div class="user-avatar" id="user-avatar">U</div>
            <span class="user-name" id="user-name">Usuario</span>
          </div>
          <button class="btn ghost" onclick="logout()">Salir</button>
        </div>
        <button id="login-btn" class="btn primary" onclick="showLoginModal()">Iniciar sesión</button>
      </div>
    </div>
  </header>

  <main>
    <div class="cal-header">
      <div class="cal-title"><h1>Calendario de lanzamientos</h1></div>
      <div class="controls">
        <button class="btn" id="prev" aria-label="Mes anterior">◀</button>
        <span class="month-pill" id="monthLabel">octubre 2025</span>
        <button class="btn" id="next" aria-label="Mes siguiente">▶</button>
      </div>
    </div>

    <div class="weekday-row" aria-hidden="true">
      <div>Lun</div><div>Mar</div><div>Mié</div><div>Jue</div><div>Vie</div><div>Sáb</div><div>Dom</div>
    </div>

    <section class="grid" id="grid" role="grid" aria-label="Calendario mensual"></section>
  </main>

  <!-- Login/Register Modal -->
  <div id="auth-modal-overlay" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card" role="document">
      <div class="modal-head">
        <h3 id="auth-modal-title" class="modal-title">Iniciar sesión</h3>
        <button class="btn ghost" onclick="closeAuthModal()" aria-label="Cerrar">✕</button>
      </div>

      <!-- Login Form -->
      <form id="login-form" class="login-form" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label for="login-username">Usuario</label>
          <input type="text" id="login-username" name="username" required autocomplete="username">
        </div>
        <div class="form-group">
          <label for="login-password">Contraseña</label>
          <input type="password" id="login-password" name="password" required autocomplete="current-password">
          <div id="login-error" class="error-msg">Usuario o contraseña incorrectos</div>
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn primary">Entrar</button>
          <button type="button" class="btn ghost" onclick="closeAuthModal()">Cancelar</button>
        </div>
        <div class="toggle-form">
          ¿No tienes cuenta? <a href="#" onclick="showRegisterForm(event)">Crear cuenta</a>
        </div>
      </form>

      <!-- Register Form -->
      <form id="register-form" class="login-form" style="display:none;" onsubmit="handleRegister(event)">
        <div class="form-group">
          <label for="register-username">Usuario</label>
          <input type="text" id="register-username" name="username" required autocomplete="username">
          <div id="register-username-error" class="error-msg">Este nombre de usuario ya está en uso</div>
        </div>
        <div class="form-group">
          <label for="register-password">Contraseña</label>
          <input type="password" id="register-password" name="password" required autocomplete="new-password" minlength="6">
          <div id="register-error" class="error-msg">Error al crear la cuenta</div>
          <div id="register-success" class="success-msg">¡Cuenta creada! Iniciando sesión...</div>
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn primary">Crear cuenta</button>
          <button type="button" class="btn ghost" onclick="closeAuthModal()">Cancelar</button>
        </div>
        <div class="toggle-form">
          ¿Ya tienes cuenta? <a href="#" onclick="showLoginForm(event)">Iniciar sesión</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Event Modal -->
  <div id="event-modal-overlay" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card" role="document">
      <div class="modal-head">
        <h3 id="modal-title" class="modal-title">Cohete – Lanzamiento</h3>
        <button class="btn ghost" onclick="closeEventModal()" aria-label="Cerrar">Cerrar</button>
      </div>

      <div id="modal-goal" class="goal-pill">
        <span class="goal-dot"></span>
        Ventana objetivo: —
      </div>

      <div class="countdown-hero"><span id="modal-countdown" data-countdown-dt=""></span></div>

      <div id="modal-info" class="modal-info"></div>
      <div id="modal-desc" class="modal-desc"></div>

      <div class="timezone-note">La cuenta atrás se basa en la hora de <strong>Europa/Madrid</strong>.</div>

      <div class="modal-actions">
        <a id="modal-watch" class="btn primary" href="#" target="_blank" rel="noopener noreferrer">Ver transmisión</a>
        <button class="btn ghost" onclick="closeEventModal()">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIGURACIÓN DE FIREBASE =====
    // ⚠️ IMPORTANTE: Reemplaza estos valores con los de tu proyecto Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDKvGLsd1jKfsSlzgTjBas-8WvbFqV1xU",
  authDomain: "eszunspace-bc900.firebaseapp.com",
  databaseURL: "https://eszunspace-bc900-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "eszunspace-bc900",
  storageBucket: "eszunspace-bc900.firebasestorage.app",
  messagingSenderId: "105651684829",
  appId: "1:105651684829:web:5c8fd5051c8c2daf24f744",
  measurementId: "G-ZDM5GF0MBW"
};

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Sistema de autenticación
    let currentUser = null;
    let allUsers = {};

    // Cargar usuarios desde Firebase Realtime Database
    async function loadUsers() {
      try {
        const snapshot = await database.ref('users').once('value');
        allUsers = snapshot.val() || {};
        console.log('Usuarios cargados desde Firebase:', Object.keys(allUsers).length);
      } catch (error) {
        console.error('Error al cargar usuarios desde Firebase:', error);
        allUsers = {};
      }
    }

    // Guardar nuevo usuario en Firebase
    async function saveUser(username, password) {
      try {
        // Verificar si el usuario ya existe
        const snapshot = await database.ref('users/' + username).once('value');
        if (snapshot.exists()) {
          console.log('Usuario ya existe:', username);
          return false;
        }

        // Guardar nuevo usuario en Firebase
        await database.ref('users/' + username).set(password);
        allUsers[username] = password;
        console.log('Usuario guardado en Firebase:', username);
        return true;
      } catch (error) {
        console.error('Error al guardar usuario en Firebase:', error);
        return false;
      }
    }

    function checkAuth() {
      if (currentUser) {
        document.getElementById('login-btn').style.display = 'none';
        document.getElementById('user-display').style.display = 'flex';
        document.getElementById('user-name').textContent = currentUser;
        document.getElementById('user-avatar').textContent = currentUser.charAt(0).toUpperCase();
      } else {
        document.getElementById('login-btn').style.display = 'inline-flex';
        document.getElementById('user-display').style.display = 'none';
      }
    }

    function showLoginModal() {
      showLoginForm();
      document.getElementById('auth-modal-overlay').classList.add('show');
    }

    function closeAuthModal() {
      document.getElementById('auth-modal-overlay').classList.remove('show');
      document.getElementById('login-error').classList.remove('show');
      document.getElementById('register-error').classList.remove('show');
      document.getElementById('register-username-error').classList.remove('show');
      document.getElementById('register-success').classList.remove('show');
    }

    function showLoginForm(e) {
      if (e) e.preventDefault();
      document.getElementById('auth-modal-title').textContent = 'Iniciar sesión';
      document.getElementById('login-form').style.display = 'flex';
      document.getElementById('register-form').style.display = 'none';
      document.getElementById('login-username').value = '';
      document.getElementById('login-password').value = '';
      document.getElementById('login-error').classList.remove('show');
    }

    function showRegisterForm(e) {
      if (e) e.preventDefault();
      document.getElementById('auth-modal-title').textContent = 'Crear cuenta';
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('register-form').style.display = 'flex';
      document.getElementById('register-username').value = '';
      document.getElementById('register-password').value = '';
      document.getElementById('register-error').classList.remove('show');
      document.getElementById('register-username-error').classList.remove('show');
      document.getElementById('register-success').classList.remove('show');
    }

    async function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      
      if (allUsers[username] && allUsers[username] === password) {
        currentUser = username;
        checkAuth();
        closeAuthModal();
      } else {
        document.getElementById('login-error').classList.add('show');
      }
    }

    async function handleRegister(e) {
      e.preventDefault();
      const username = document.getElementById('register-username').value.trim();
      const password = document.getElementById('register-password').value;
      
      // Limpiar mensajes anteriores
      document.getElementById('register-error').classList.remove('show');
      document.getElementById('register-username-error').classList.remove('show');
      document.getElementById('register-success').classList.remove('show');
      
      // Validar que el usuario no exista
      if (allUsers[username]) {
        document.getElementById('register-username-error').classList.add('show');
        return;
      }
      
      // Guardar usuario en Firebase
      const saved = await saveUser(username, password);
      
      if (saved) {
        document.getElementById('register-success').classList.add('show');
        
        // Iniciar sesión automáticamente después de 1.5 segundos
        setTimeout(() => {
          currentUser = username;
          checkAuth();
          closeAuthModal();
        }, 1500);
      } else {
        document.getElementById('register-error').classList.add('show');
      }
    }

    function logout() {
      currentUser = null;
      checkAuth();
    }

    document.addEventListener("DOMContentLoaded", async () => {
      document.body.classList.add("fade-in");
      await loadUsers();
      checkAuth();
    });

    const monthLabel = document.getElementById('monthLabel');
    const grid = document.getElementById('grid');
    const btnPrev = document.getElementById('prev');
    const btnNext = document.getElementById('next');

    const EVENTS = [
      {
        id: "neutron-2025-10-04",
        title: "Cohete Neutron – Lanzamiento",
        vehicle: "Neutron",
        datetimeISO: "2025-10-04T23:00:00+02:00",
        streamUrl: "https://youtu.be/vCODD_Nc400",
        description: "Este evento corresponde al lanzamiento del Neutron. La cuenta atrás se basa en la hora de Europa/Madrid.",
        mission: "Neutron Snipex-1 Launch",
        site: "Plataforma LC-39A, Centro Espacial Kennedy, Cabo Cañaveral, Florida (EE.UU.)",
        vehicleFull: "Neutron (EsZunSpace)",
        payload: "Satélite Snipex-1",
        orbit: "140 km x 140 km circular (LEO)"
      }
    ];

    function sameDay(a, b){
      return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
    }
    
    function startCountdowns(){
      const nodes = document.querySelectorAll('[data-countdown-dt]');
      function fmt(diffMs){
        if (diffMs <= 0) {
          const sec = Math.abs(Math.floor(diffMs/1000));
          const d = Math.floor(sec/86400);
          const h = Math.floor((sec%86400)/3600);
          const m = Math.floor((sec%3600)/60);
          const s = sec%60;
          return `T+ ${d>0? d+'d':'0d'} ${String(h).padStart(2,'0')}h ${String(m).padStart(2,'0')}m ${String(s).padStart(2,'0')}s`;
        }
        const sec = Math.floor(diffMs/1000);
        const d = Math.floor(sec/86400);
        const h = Math.floor((sec%86400)/3600);
        const m = Math.floor((sec%3600)/60);
        const s = sec%60;
        return `T- ${d>0? d+'d':'0d'} ${String(h).padStart(2,'0')}h ${String(m).padStart(2,'0')}m ${String(s).padStart(2,'0')}s`;
      }
      function tick(){
        const now = new Date();
        nodes.forEach(el=>{
          const target = new Date(el.getAttribute('data-countdown-dt'));
          el.textContent = fmt(target - now);
        });
      }
      tick();
      clearInterval(window.__countdownInterval);
      window.__countdownInterval = setInterval(tick, 1000);
    }

    let current = new Date();
    current.setDate(1);
    const MES = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
    function firstDayMondayIndex(date){ const d=new Date(date); return (d.getDay()+6)%7; }
    function daysInMonth(date){ return new Date(date.getFullYear(), date.getMonth()+1, 0).getDate(); }
    function isToday(d){ const t=new Date(); return d.getFullYear()===t.getFullYear() && d.getMonth()===t.getMonth() && d.getDate()===t.getDate(); }

    function render(){
      const year = current.getFullYear();
      const month = current.getMonth();
      monthLabel.textContent = `${MES[month]} ${year}`;

      grid.innerHTML = '';
      const firstIdx = firstDayMondayIndex(current);
      const total = daysInMonth(current);

      for(let i=0;i<firstIdx;i++){ const cell=document.createElement('div'); cell.className='day'; grid.appendChild(cell); }

      for(let day=1; day<=total; day++){
        const cell = document.createElement('div');
        cell.className = 'day';
        const date = new Date(year, month, day);
        if(isToday(date)) cell.classList.add('today');

        const num = document.createElement('span');
        num.className = 'num'; num.textContent = day;

        const events = document.createElement('div');
        events.className = 'events';

        const todaysEvents = EVENTS.filter(ev => sameDay(new Date(ev.datetimeISO), new Date(year, month, day)));

        todaysEvents.forEach(ev => {
          const card = document.createElement('div');
          card.className = 'event-mini-card';
          card.addEventListener('click', ()=> openEventModal(ev));

          const title = document.createElement('div');
          title.className = 'event-mini-title';
          title.textContent = ev.vehicle;

          const countdown = document.createElement('div');
          countdown.className = 'event-mini-eta';
          countdown.setAttribute('data-countdown-dt', ev.datetimeISO);

          card.appendChild(title);
          card.appendChild(countdown);
          events.appendChild(card);
        });

        cell.appendChild(num);
        cell.appendChild(events);
        grid.appendChild(cell);
      }
    }

    btnPrev.addEventListener('click', ()=>{ current.setMonth(current.getMonth()-1); render(); startCountdowns(); });
    btnNext.addEventListener('click', ()=>{ current.setMonth(current.getMonth()+1); render(); startCountdowns(); });

    render();
    startCountdowns();

    function capitalizarPrimera(s){
      return s ? s.charAt(0).toUpperCase() + s.slice(1) : s;
    }
    function formatGoalWindow(dtISO){
      const dt = new Date(dtISO);
      const opts = { weekday:'long', day:'numeric', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit' };
      const s = dt.toLocaleString('es-ES', opts);
      return s.replace(/^\w/, c=>c.toLowerCase());
    }
    function formatLongDate(dtISO){
      const dt = new Date(dtISO);
      const opts = { weekday:'long', day:'numeric', month:'long', year:'numeric', hour:'2-digit', minute:'2-digit' };
      let s = dt.toLocaleString('es-ES', opts);
      s = s.replace(/^\w/, c=>c.toLowerCase());
      return capitalizarPrimera(s);
    }
    function openEventModal(ev){
      const overlay = document.getElementById('event-modal-overlay');
      const title = document.getElementById('modal-title');
      const goal = document.getElementById('modal-goal');
      const countdown = document.getElementById('modal-countdown');
      const info = document.getElementById('modal-info');
      const desc = document.getElementById('modal-desc');
      const watch = document.getElementById('modal-watch');

      title.textContent = ev.title || 'Evento';
      goal.innerHTML = `<span class="goal-dot"></span> Ventana objetivo: ${formatGoalWindow(ev.datetimeISO)} (España)`;
      countdown.setAttribute('data-countdown-dt', ev.datetimeISO);

      if (["neutron-2025-10-03","neutron-2025-10-04"].includes(ev.id)) {
        const fecha = `${formatLongDate(ev.datetimeISO)} (hora de España)`;
        info.innerHTML = `
          <div><b>Misión:</b> ${ev.mission}</div>
          <div><b>Fecha de lanzamiento:</b> ${fecha}</div>
          <div><b>Lugar:</b> ${ev.site}</div>
          <div><b>Vehículo:</b> ${ev.vehicleFull}</div>
          <div><b>Carga útil:</b> ${ev.payload}</div>
          <div><b>Órbita objetivo:</b> ${ev.orbit}</div>
        `;
        info.style.display = 'grid';
        desc.textContent = '';
      } else {
        info.style.display = 'none';
        desc.textContent = ev.description || '';
      }

      if (ev.streamUrl) { watch.href = ev.streamUrl; watch.style.display='inline-flex'; }
      else { watch.style.display='none'; }

      overlay.classList.add('show');
      overlay.setAttribute('aria-hidden','false');

      startCountdowns();
    }
    function closeEventModal(){
      const overlay = document.getElementById('event-modal-overlay');
      overlay.classList.remove('show');
      overlay.setAttribute('aria-hidden','true');
    }
  </script>
</body>
</html>