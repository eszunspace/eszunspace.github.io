<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lanzamientos EsZunSpace</title>
  <link rel="icon" type="image/jpeg" href="logoarriba.jpg">
  <style>
    :root {
      --bg-image: url('background.jpg');
      --header-h: 64px;
      --card-bg: #5a6b8c;
      /* Slate blue-ish base */
      --card-bg-2: #4a5a7a;
      --text-main: #ffffff;
      --text-muted: rgba(255, 255, 255, 0.7);
      --accent: #00f0ff;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      margin: 0;
      background-color: #f0f0f0;
      /* Fallback light, though we use dark scheme */
    }

    body {
      font-family: 'Poppins', system-ui, sans-serif;
      color: #fff;
      background: #ffffff;
      /* We'll override with image or dark bg */
      background-color: #0b0b0f;
      opacity: 0;
      transition: opacity 0.6s ease;
    }

    body.fade-in {
      opacity: 1;
    }

    /* ===== Header c√°psula con marcador activo ===== */
    header.topbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      padding: 12px 12px;
      background: linear-gradient(180deg, rgba(0, 0, 0, .65) 0%, rgba(0, 0, 0, 0) 100%);
      -webkit-backdrop-filter: blur(2px);
      backdrop-filter: blur(2px);
    }

    .nav-shell {
      width: min(1200px, 94vw);
      margin: 0 auto;
      height: var(--header-h);
      padding: 0 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.07), rgba(255, 255, 255, 0.03));
      border: 1px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 10px 30px rgba(0, 0, 0, .6);
      position: relative;
      overflow: hidden;
    }

    .nav-shell::before {
      content: "";
      position: absolute;
      inset: -1px;
      background: conic-gradient(from 0deg, #00f0ff, #ff00d4, #00f0ff);
      filter: blur(22px);
      opacity: .14;
      pointer-events: none;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: #fff;
      min-width: 0;
    }

    .brand img {
      height: 36px;
      width: 36px;
      border-radius: 50%;
      box-shadow: 0 0 8px rgba(255, 255, 255, .1)
    }

    .brand .title {
      font-family: 'Space Grotesk', system-ui, sans-serif;
      font-weight: 800;
      letter-spacing: .02em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-size: 16px;
      /* Adjusted slightly for safety */
    }

    /* === Toggle (mobile) === */
    .menu-toggle {
      display: none;
      background: transparent;
      border: 0;
      color: #fff;
      width: 44px;
      height: 44px;
      border-radius: 12px;
    }

    .menu-toggle:focus-visible {
      outline: 2px solid #00f0ff;
      outline-offset: 2px;
    }

    .menu {
      display: flex;
      align-items: center;
      gap: 18px
    }

    .menu a {
      position: relative;
      display: inline-flex;
      align-items: center;
      padding: 10px 10px;
      text-decoration: none;
      color: #fff;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .08em;
      font-size: 12px;
      opacity: .9;
      transition: opacity .2s ease;
      -webkit-tap-highlight-color: transparent;
    }

    .menu a:hover {
      opacity: 1
    }

    .menu a::after {
      content: "";
      position: absolute;
      left: 12px;
      right: 12px;
      bottom: 6px;
      height: 2px;
      background: linear-gradient(90deg, #00f0ff, #ff00d4);
      transform: scaleX(0);
      transform-origin: left;
      transition: transform .25s ease;
      border-radius: 2px;
    }

    .menu a:hover::after {
      transform: scaleX(1);
    }

    .menu a[aria-current="page"] {
      opacity: 1
    }

    .menu a[aria-current="page"]::after {
      transform: scaleX(1);
    }

    /* User section */
    .user-section {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 10px;
      background: rgba(255, 255, 255, .06);
      border: 1px solid rgba(255, 255, 255, .18);
      cursor: pointer;
      transition: transform .15s ease, background .2s ease, border-color .2s ease;
    }

    .user-info:hover {
      transform: translateY(-1px);
      background: rgba(255, 255, 255, .1);
      border-color: rgba(255, 255, 255, .3);
    }

    .user-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: linear-gradient(135deg, #00f0ff, #ff00d4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 12px;
    }

    .user-name {
      font-weight: 600;
      font-size: 13px;
    }

    /* Mobile: user section in header */
    @media (max-width: 900px) {
      .user-section #user-display .user-info {
        padding: 4px 8px;
      }

      .user-section #user-display .user-avatar {
        width: 32px;
        height: 32px;
        font-size: 14px;
      }

      .user-section #user-display .user-name {
        display: none;
      }

      .user-section #login-btn {
        padding: 0 12px;
        font-size: 12px;
        height: 36px;
      }
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 32px;
      min-width: 32px;
      padding: 0 10px;
      border-radius: 10px;
      background: rgba(255, 255, 255, .06);
      border: 1px solid rgba(255, 255, 255, .18);
      color: #fff;
      cursor: pointer;
      user-select: none;
      transition: transform .15s ease, background .2s ease, border-color .2s ease;
      text-decoration: none;
      gap: 8px;
      font-family: inherit;
      font-size: 13px;
    }

    .btn:hover {
      transform: translateY(-1px);
      background: rgba(255, 255, 255, .1);
      border-color: rgba(255, 255, 255, .3)
    }

    .btn.primary {
      border: 0;
      background: linear-gradient(90deg, #00f0ff, #ff00d4);
      font-weight: 700;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .35);
    }

    .btn.ghost {
      background: rgba(255, 255, 255, .06);
    }

    /* ===== Main Layout ===== */
    .main-content {
      padding-top: 100px;
      padding-bottom: 60px;
      min-height: 100vh;
      background-image: var(--bg-image);
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }

    .main-overlay {
      position: fixed;
      inset: 0;
      background: rgba(11, 11, 15, 0.85);
      /* Darken background */
      z-index: -1;
    }

    .container {
      width: min(1200px, 94vw);
      margin: 0 auto;
    }

    /* Month Navigation */
    .month-nav {
      display: flex;
      align-items: center;
      gap: 20px;
      margin-bottom: 30px;
    }

    .month-title {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 48px;
      font-weight: 900;
      text-transform: uppercase;
      margin: 0;
      color: #fff;
      /* White text as per image */
      line-height: 1;
    }

    .month-year {
      opacity: 0.7;
    }

    .nav-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #000;
      border: none;
      color: #fff;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s;
    }

    .nav-btn:hover {
      transform: scale(1.1);
      background: #222;
    }

    /* Grid */
    .launch-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
    }

    /* Card Style - Matching Reference */
    .card {
      position: relative;
      height: 450px;
      border-radius: 12px;
      overflow: hidden;
      background-color: #586c8a;
      /* Slate blue fallback */
      background-size: cover;
      background-position: center;
      display: flex;
      flex-direction: column;
      text-align: left;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
    }

    /* Overlay gradient for text readability */
    .card::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(0, 0, 0, 0.1) 0%, rgba(0, 0, 0, 0.4) 50%, rgba(90, 107, 140, 0.95) 75%, rgba(90, 107, 140, 1) 100%);
      z-index: 1;
    }

    /* Specific overrides for different cards colors if needed, 
       but for now we use a generic slate for the bottom part logic or just image with gradient */

    .card-content {
      position: relative;
      z-index: 2;
      padding: 24px;
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    /* Date Badge */
    .date-badge {
      margin-bottom: 8px;
    }

    .date-day {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 32px;
      font-weight: 700;
      line-height: 1;
      display: block;
    }

    .date-month {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      opacity: 0.8;
      letter-spacing: 0.5px;
    }

    /* Main Info */
    .rocket-mission {
      margin-top: 4px;
      font-family: 'Space Grotesk', sans-serif;
      font-size: 20px;
      font-weight: 800;
      text-transform: uppercase;
      line-height: 1.1;
      margin-bottom: 12px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .rocket-mission span {
      display: inline-block;
    }

    .separator {
      color: rgba(255, 255, 255, 0.6);
      margin: 0 4px;
    }

    /* Time & Action */
    .time-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
    }

    .launch-time {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .timezone-btn {
      font-size: 10px;
      padding: 4px 8px;
      border: 1px solid rgba(255, 255, 255, 0.4);
      border-radius: 20px;
      background: rgba(0, 0, 0, 0.2);
      color: #fff;
      text-decoration: none;
      cursor: pointer;
    }

    /* Footer Details (pushed to bottom) */
    .card-footer {
      margin-top: auto;
      font-size: 11px;
      color: rgba(255, 255, 255, 0.9);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .location-row {
      display: flex;
      gap: 6px;
      line-height: 1.3;
      margin-bottom: 4px;
      opacity: 0.9;
    }

    .detail-item {
      display: flex;
      gap: 4px;
    }

    .label {
      opacity: 0.6;
      font-style: italic;
    }

    /* Modal reused styles (minimized for brevity) */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .modal-overlay.show {
      display: flex;
    }

    .modal-card {
      background: rgba(18, 18, 22, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 24px;
      border-radius: 16px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      width: min(800px, 95vw);
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
      scrollbar-width: none;
    }

    .modal-card::-webkit-scrollbar {
      display: none;
    }

    @media (max-width: 768px) {
      :root {
        --header-h: 56px;
      }

      .brand img {
        width: 32px;
        height: 32px;
      }

      .nav-shell {
        padding: 0 10px;
        border-radius: 14px;
      }

      .menu-toggle {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }

      .menu {
        position: fixed;
        top: 76px;
        left: 8px;
        right: 8px;
        display: none;
        flex-direction: column;
        align-items: stretch;
        gap: 6px;
        padding: 10px;
        background: rgba(18, 18, 18, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 16px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, .6);
        backdrop-filter: blur(12px);
        z-index: 999;
      }

      .menu.open {
        display: flex;
      }

      .menu a {
        padding: 14px 12px;
        font-size: 13px;
        letter-spacing: .12em;
        border-radius: 10px;
      }

      .menu a::after {
        display: none;
      }

      .menu a:hover,
      .menu a[aria-current="page"] {
        background: rgba(255, 255, 255, 0.06);
      }

      .brand .title {
        font-size: 16px;
      }

      .month-title {
        font-size: 28px;
      }

      .month-nav {
        gap: 12px;
        margin-bottom: 20px;
      }

      .view-controls {
        flex-direction: column;
        gap: 12px;
        padding: 12px;
      }

      .toggle-group {
        width: 100%;
        justify-content: center;
      }

      .toggle-btn {
        flex: 1;
        padding: 8px 10px;
        font-size: 11px;
      }

      .filter-bar {
        flex-direction: column;
        gap: 12px;
        width: 100%;
      }

      .filter-item {
        width: 100%;
      }

      .filter-select,
      .search-input {
        width: 100%;
      }

      .launch-grid {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .card {
        height: 400px;
      }

      .card-content {
        padding: 18px;
      }

      .rocket-mission {
        font-size: 18px;
      }

      .user-section #login-btn {
        padding: 0 12px;
        font-size: 12px;
        height: 36px;
      }
    }

    /* Extra small phones */
    @media (max-width: 420px) {
      .month-title {
        font-size: 24px;
      }

      .card {
        height: 360px;
        border-radius: 10px;
      }

      .date-day {
        font-size: 26px;
      }

      .rocket-mission {
        font-size: 16px;
      }

      .toggle-btn {
        padding: 6px 8px;
        font-size: 10px;
      }
    }

    /* Filters */
    .view-controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 25px;
      background: rgba(0, 0, 0, 0.4);
      padding: 15px;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .toggle-group {
      display: flex;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      padding: 4px;
      gap: 4px;
    }

    .toggle-btn {
      border: none;
      background: transparent;
      color: rgba(255, 255, 255, 0.6);
      padding: 6px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .toggle-btn.active {
      background: #00f0ff;
      color: #000;
    }

    /* Status Badges */
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      margin-top: 5px;
      letter-spacing: 0.5px;
    }

    .status-badge.success {
      background: rgba(0, 255, 136, 0.2);
      color: #00ff88;
      border: 1px solid rgba(0, 255, 136, 0.4);
    }

    .status-badge.failure {
      background: rgba(255, 0, 85, 0.2);
      color: #ff0055;
      border: 1px solid rgba(255, 0, 85, 0.4);
    }

    .status-badge.upcoming {
      background: rgba(0, 224, 255, 0.2);
      color: #00e0ff;
      border: 1px solid rgba(0, 224, 255, 0.4);
    }

    .filter-bar {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
      display: none;
      /* Hidden by default in Month view */
    }

    .filter-bar.show {
      display: flex;
    }

    .filter-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-label {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
    }

    .filter-select,
    .search-input {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: #fff;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 13px;
      outline: none;
    }

    .search-input {
      width: 180px;
    }

    /* Month Nav visibility control */
    .month-nav.hidden {
      display: none;
    }

    @media (max-width: 900px) {
      .view-controls {
        flex-direction: column;
        align-items: stretch;
      }
    }

    /* Filter Bar */
    .view-controls {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
    }

    .toggle-group {
      display: flex;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 6px;
      padding: 4px;
    }

    .toggle-btn {
      background: transparent;
      border: none;
      color: rgba(255, 255, 255, 0.6);
      padding: 6px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .toggle-btn.active {
      background: #00e0ff;
      color: #000;
      box-shadow: 0 0 10px rgba(0, 224, 255, 0.4);
    }

    .filter-bar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
      animation: fadeIn 0.3s ease-out;
    }

    .filter-select,
    .filter-search {
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 13px;
      outline: none;
    }

    .filter-search {
      flex-grow: 1;
      min-width: 200px;
    }

    /* Modal Redesign (Cyberpunk Style) */
    .modal-banner-container {
      position: relative;
      width: 100%;
      height: 250px;
      background-size: cover;
      background-position: center;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 20px;
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
    }

    .modal-banner-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0, 0, 0, 0.95), transparent);
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      justify-content: flex-end;
      height: 100%;
    }

    .modal-hero-title {
      font-size: 28px;
      font-weight: 800;
      text-transform: uppercase;
      color: white;
      text-shadow: 0 0 10px rgba(0, 0, 0, 0.8);
      letter-spacing: 1px;
      margin-bottom: 5px;
    }

    .modal-countdown {
      font-family: 'Courier New', monospace;
      font-size: 20px;
      color: #00e0ff;
      font-weight: 700;
      margin-bottom: 5px;
      text-shadow: 0 0 8px rgba(0, 224, 255, 0.6);
    }

    .social-links {
      display: flex;
      gap: 15px;
      font-size: 16px;
      color: #00e0ff;
      opacity: 0.8;
    }

    .modal-description {
      font-size: 14px;
      line-height: 1.6;
      color: rgba(255, 255, 255, 0.85);
      margin-bottom: 25px;
    }

    .details-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    @media (max-width: 600px) {
      .details-grid {
        grid-template-columns: 1fr;
      }
    }

    .detail-box {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      padding: 20px;
      position: relative;
      transition: background 0.2s;
    }

    .detail-box:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .detail-box h3 {
      color: rgba(255, 255, 255, 0.95);
      font-size: 13px;
      text-transform: uppercase;
      margin-top: 0;
      margin-bottom: 20px;
      letter-spacing: 1.5px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .detail-box h3::before {
      content: '';
      display: block;
      width: 4px;
      height: 14px;
      background: #00e0ff;
      border-radius: 2px;
      box-shadow: 0 0 8px rgba(0, 224, 255, 0.4);
    }

    .detail-row {
      margin-bottom: 12px;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
      display: flex;
      align-items: center;
      gap: 10px;
      padding-bottom: 4px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .footer-text {
      margin-top: 20px;
      font-size: 12px;
      line-height: 1.6;
      color: rgba(255, 255, 255, 0.4);
      font-style: italic;
      border-top: none;
      padding-top: 0;
    }
  </style>
</head>

<body>

  <header class="topbar">
    <div class="nav-shell">
      <a class="brand" href="index.html">
        <img src="logoarriba.jpg" alt="Logo">
        <span class="title">EsZunSpace</span>
      </a>

      <!-- Toggle s√≥lo visible en m√≥vil -->
      <button class="menu-toggle" aria-controls="primary-menu" aria-expanded="false" aria-label="Abrir men√∫">
        <svg width="24" height="24" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>
      </button>

      <nav id="primary-menu" class="menu">
        <a href="calendario.html">Calendario</a>
        <a href="cohetes.html">Cohetes</a>
        <a href="motores.html">Motores</a>
        <a href="sat√©lites.html">Sat√©lites</a>
        <a href="lanzamientos.html" aria-current="page">Lanzamientos</a>
        <a href="stream.html">Stream</a>
        <div id="mobile-logout-section"
          style="display:none; margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,.12);">
          <button class="btn ghost" onclick="logout()" style="width:100%; justify-content:center;">Cerrar
            sesi√≥n</button>
        </div>
      </nav>
      <div class="user-section">
        <a id="login-btn" class="btn primary" href="#">Login</a>
      </div>
    </div>
  </header>

  <div class="main-overlay"></div>

  <main class="main-content">
    <div class="container">

      <!-- View & Filter Controls -->
      <div class="view-controls">
        <div class="toggle-group">
          <button class="toggle-btn active" onclick="setViewMode('month')" id="btn-month">POR MES</button>
          <button class="toggle-btn" onclick="setViewMode('all')" id="btn-all">VER TODO</button>
          <button class="toggle-btn" onclick="openStatsModal()" id="btn-stats">ESTAD√çSTICAS</button>
        </div>

        <div class="filter-bar" id="filter-bar">
          <div class="filter-item">
            <span class="filter-label">Estado:</span>
            <select class="filter-select" id="filter-status" onchange="renderCalendar()">
              <option value="all">Todos</option>
              <option value="upcoming">Programados</option>
              <option value="past">Realizados</option>
              <option value="success">√âxito</option>
              <option value="failure">Fallo</option>
            </select>
          </div>
          <div class="filter-item">
            <span class="filter-label">Veh√≠culo:</span>
            <select class="filter-select" id="filter-vehicle" onchange="renderCalendar()">
              <option value="all">Todos</option>
              <!-- Populated by JS -->
            </select>
          </div>
          <div class="filter-item">
            <span class="filter-label">Plataforma:</span>
            <select class="filter-select" id="filter-site" onchange="renderCalendar()">
              <option value="all">Todas</option>
              <!-- Populated by JS -->
            </select>
          </div>
          <div class="filter-item">
            <span class="filter-label">Buscar:</span>
            <input type="text" class="search-input" id="filter-search" placeholder="Misi√≥n..."
              oninput="renderCalendar()">
          </div>
          <div class="filter-item">
            <span class="filter-label">Ordenar:</span>
            <select class="filter-select" id="filter-sort" onchange="renderCalendar()">
              <option value="asc">M√°s Antiguos</option>
              <option value="desc">M√°s Recientes</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Month Header -->
      <div class="month-nav" id="month-nav-container">
        <h1 class="month-title" id="month-display">ENERO, 2026</h1>
        <button class="nav-btn" onclick="changeMonth(-1)">&#8249;</button>
        <button class="nav-btn" onclick="changeMonth(1)">&#8250;</button>
      </div>

      <!-- Grid -->
      <div class="launch-grid" id="launches-grid">
        <!-- Cards injected by JS -->
        <div style="color:white; opacity:0.6;">Cargando...</div>
      </div>

    </div>
  </main>

  <!-- Modals -->
  <!-- Stats Modal -->
  <div id="stats-modal-overlay" class="modal-overlay"
    onclick="if(event.target===this) document.getElementById('stats-modal-overlay').classList.remove('show')">
    <div class="modal-card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h2 class="modal-hero-title" style="font-size:20px; margin:0;">Estad√≠sticas de Lanzamiento</h2>
        <button class="btn secondary" onclick="document.getElementById('stats-modal-overlay').classList.remove('show')"
          style="padding:5px 10px;">‚úï</button>
      </div>

      <div class="details-grid" style="grid-template-columns: 1fr 1fr; gap:20px;">
        <!-- Chart 1: Success Rate -->
        <div class="detail-box"
          style="display:flex; flex-direction:column; align-items:center; justify-content:center;">
          <h3>Lanzamientos</h3>
          <div class="chart-container"
            style="position:relative; width:150px; height:150px; border-radius:50%; background: conic-gradient(#00e0ff 0% 0%, #ff0055 0% 100%); margin-bottom:15px;"
            id="chart-success">
            <div style="position:absolute; inset:10px; background:#1a1a1e; border-radius:50%;"></div>
            <div
              style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column; z-index:1;">
              <span id="stat-percent" style="font-size:24px; font-weight:bold; color:white;">0%</span>
            </div>
          </div>
          <div style="display:flex; gap:15px; font-size:12px;">
            <div style="display:flex; align-items:center; gap:5px;"><span
                style="width:10px; height:10px; background:#00e0ff; border-radius:2px;"></span> √âxito</div>
            <div style="display:flex; align-items:center; gap:5px;"><span
                style="width:10px; height:10px; background:#ff0055; border-radius:2px;"></span> Fallo</div>
          </div>
        </div>

        <!-- General Stats (Launch) -->
        <div class="detail-box">
          <h3>Resumen General</h3>
          <div class="detail-row">üöÄ <strong>Total Lanzamientos:</strong> <span id="stat-total"
              style="color:white; margin-left:auto;">0</span></div>
          <div class="detail-row">‚úÖ <strong>√âxitos:</strong> <span id="stat-success-count"
              style="color:#00e0ff; margin-left:auto;">0</span></div>
          <div class="detail-row">‚ùå <strong>Fallos:</strong> <span id="stat-failure-count"
              style="color:#ff0055; margin-left:auto;">0</span></div>
          <div class="detail-row">üìÖ <strong>Programados:</strong> <span id="stat-upcoming"
              style="color:rgba(255,255,255,0.6); margin-left:auto;">0</span></div>
        </div>

        <!-- Chart 2: Landing Rate -->
        <div class="detail-box"
          style="display:flex; flex-direction:column; align-items:center; justify-content:center;">
          <h3>Aterrizajes</h3>
          <div class="chart-container"
            style="position:relative; width:150px; height:150px; border-radius:50%; background: conic-gradient(#00e0ff 0% 0%, #ff0055 0% 100%); margin-bottom:15px;"
            id="chart-landing">
            <div style="position:absolute; inset:10px; background:#1a1a1e; border-radius:50%;"></div>
            <div
              style="position:absolute; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column; z-index:1;">
              <span id="stat-landing-percent" style="font-size:24px; font-weight:bold; color:white;">0%</span>
            </div>
          </div>
          <div style="display:flex; gap:15px; font-size:12px;">
            <div style="display:flex; align-items:center; gap:5px;"><span
                style="width:10px; height:10px; background:#00e0ff; border-radius:2px;"></span> √âxito</div>
            <div style="display:flex; align-items:center; gap:5px;"><span
                style="width:10px; height:10px; background:#ff0055; border-radius:2px;"></span> Fallo</div>
          </div>
        </div>

        <!-- General Stats (Landing) -->
        <div class="detail-box">
          <h3>Resumen Aterrizajes</h3>
          <div class='detail-row'>üõ¨ <strong>Total Intentos:</strong> <span id='stat-landing-total'
              style="color:white; margin-left:auto;">0</span></div>
          <div class="detail-row">‚úÖ <strong>√âxitos:</strong> <span id="stat-landing-success"
              style="color:#00e0ff; margin-left:auto;">0</span></div>
          <div class="detail-row">‚ùå <strong>Fallos:</strong> <span id="stat-landing-failure"
              style="color:#ff0055; margin-left:auto;">0</span></div>
        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- Auth Modal -->
  <div id="auth-modal-overlay" class="modal-overlay" onclick="if(event.target===this) closeAuthModal()">
    <div class="modal-card" style="width: 400px;">
      <h3 style="margin-top:0">Iniciar Sesi√≥n</h3>
      <form id="login-form" onsubmit="handleLogin(event)">
        <div style="margin-bottom:15px">
          <label style="display:block; margin-bottom:5px; font-size:13px; font-weight:600">Usuario</label>
          <input id="login-username" required
            style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.05); color:white;">
        </div>
        <div style="margin-bottom:20px">
          <label style="display:block; margin-bottom:5px; font-size:13px; font-weight:600">Contrase√±a</label>
          <input type="password" id="login-password" required
            style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.05); color:white;">
        </div>
        <div style="display:flex; justify-content:flex-end; gap:10px;">
          <button type="button" class="btn" onclick="closeAuthModal()">Cancelar</button>
          <button type="submit" class="btn primary">Entrar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add/Edit Launch Modal -->
  <div id="launch-modal" class="modal-overlay" onclick="if(event.target===this) closeLaunchModal()">
    <div class="modal-card">
      <h3 id="launch-modal-title" style="margin-top:0">A√±adir Lanzamiento</h3>
      <form onsubmit="saveLaunch(event)">
        <input type="hidden" id="launch-id">

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
          <div>
            <label class="label">Veh√≠culo</label>
            <input id="launch-vehicle" required placeholder="Ej: FALCON 9"
              style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.05); color:white; margin-top:5px;">
          </div>
          <div>
            <label class="label">N¬∫ Vuelo</label>
            <input id="launch-flight-num" placeholder="#102"
              style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.05); color:white; margin-top:5px;">
          </div>
        </div>

        <div style="margin-top:15px; display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
          <div>
            <label class="label">Misi√≥n</label>
            <input id="launch-mission" required placeholder="Ej: STARLINK 6-24"
              style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.05); color:white; margin-top:5px;">
          </div>
          <div>
            <label class="label">Cliente</label>
            <input id="launch-client" placeholder="Ej: NASA, SpaceX"
              style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.05); color:white; margin-top:5px;">
          </div>
        </div>

        <div style="margin-top:15px; display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
          <div>
            <label class="label">Fecha y Hora</label>
            <input type="datetime-local" id="launch-date" required
              style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.05); color:white; margin-top:5px;">
          </div>
          <div>
            <label class="label">Estado</label>
            <select id="launch-status" required
              style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.05); color:white; margin-top:5px;">
              <option value="upcoming">Programado</option>
              <option value="success">√âxito</option>
              <option value="failure">Fallo</option>
            </select>
          </div>
        </div>

        <div style="margin-top:15px; display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
          <div>
            <label class="label">Sitio de Lanzamiento</label>
            <input id="launch-site" placeholder="Ej: LC-39A"
              style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.05); color:white; margin-top:5px;">
          </div>
          <div>
            <label class="label">Destino / √ìrbita</label>
            <input id="launch-orbit" placeholder="Ej: LEO, GEO"
              style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.05); color:white; margin-top:5px;">
          </div>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-top:15px;">
          <div>
            <label class="label">Proveedor</label>
            <input id="launch-provider" value="EsZunSpace"
              style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.05); color:white; margin-top:5px;">
          </div>
          <div>
            <label class="label">Aterrizaje</label>
            <input id="launch-landing" placeholder="Ej: OCISLY"
              style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.05); color:white; margin-top:5px;">
            <select id="launch-landing-status"
              style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.05); color:white; margin-top:10px;">
              <option value="na">N/A (No intento)</option>
              <option value="upcoming">Programado</option>
              <option value="success">√âxito</option>
              <option value="failure">Fallo</option>
            </select>
          </div>
        </div>

        <div style="margin-top:15px;">
          <label class="label">Carga √ötil</label>
          <input id="launch-payload" placeholder="Ej: 23 Sat√©lites Starlink (16.5t)"
            style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.05); color:white; margin-top:5px;">
        </div>

        <div style="margin-top:15px;">
          <label class="label">Imagen (Banner)</label>
          <input type="file" id="launch-image-file" accept="image/*" style="margin-top:5px; color:white;">
          <input type="hidden" id="launch-image-base64">
          <div id="image-preview"
            style="margin-top:10px; height:100px; background-size:cover; background-position:center; border-radius:8px; display:none;">
          </div>
        </div>

        <div style="margin-top:15px;">
          <label class="label">Descripci√≥n / Detalles</label>
          <textarea id="launch-desc" rows="3"
            style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.05); color:white; margin-top:5px;"></textarea>
        </div>

        <div style="margin-top:15px;">
          <label class="label">Texto al pie (Info extra)</label>
          <textarea id="launch-footer-text" rows="2" placeholder="Ej: No hay informaci√≥n sobre la carga..."
            style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:rgba(255,255,255,0.05); color:white; margin-top:5px;"></textarea>
        </div>

        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:20px;">
          <button type="button" class="btn" onclick="closeLaunchModal()">Cancelar</button>
          <button type="submit" class="btn primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Event Details Modal (Read-only) -->
  <div id="event-modal" class="modal-overlay" onclick="if(event.target===this) this.classList.remove('show')">
    <div class="modal-card">
      <h2 id="modal-title">Detalles</h2>
      <div id="modal-content" style="line-height:1.6; color:rgba(255,255,255,0.85)"></div>
      <button class="btn" style="margin-top:20px"
        onclick="document.getElementById('event-modal').classList.remove('show')">Cerrar</button>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDKvGLsd1jKfsSlzgTjBas-8WvbFqV1xU",
      authDomain: "eszunspace-bc900.firebaseapp.com",
      databaseURL: "https://eszunspace-bc900-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "eszunspace-bc900",
      storageBucket: "eszunspace-bc900.firebasestorage.app",
      messagingSenderId: "105651684829",
      appId: "1:105651684829:web:5c8fd5051c8c2daf24f744"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    const ADMINS = ['Esstor'];
    let currentUser = localStorage.getItem('esz_user');
    let allLaunches = [];
    let currentDate = new Date();
    // Set to start of month
    currentDate.setDate(1);

    // View Mode: 'month' or 'all'
    let viewMode = 'all';

    const monthNames = ["ENERO", "FEBRERO", "MARZO", "ABRIL", "MAYO", "JUNIO", "JULIO", "AGOSTO", "SEPTIEMBRE", "OCTUBRE", "NOVIEMBRE", "DICIEMBRE"];

    document.addEventListener("DOMContentLoaded", () => {
      document.body.classList.add('fade-in');
      checkUser();

      // Mobile menu toggle
      const menuToggle = document.querySelector('.menu-toggle');
      const menu = document.querySelector('.menu');
      if (menuToggle && menu) {
        menuToggle.addEventListener('click', () => {
          const isOpen = menu.classList.toggle('open');
          menuToggle.setAttribute('aria-expanded', isOpen);
        });
        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
          if (!menu.contains(e.target) && !menuToggle.contains(e.target)) {
            menu.classList.remove('open');
            menuToggle.setAttribute('aria-expanded', 'false');
          }
        });
      }

      // Initialize view
      setViewMode('all');

      loadLaunches();

      // Add "Add Launch" button to header if admin
      if (isAdmin()) {
        const nav = document.querySelector('.nav-shell');
        const addBtn = document.createElement('button');
        addBtn.className = 'btn primary';
        addBtn.style.marginLeft = '10px';
        addBtn.innerText = '+ Lanzamiento';
        addBtn.onclick = openAddLaunchModal;
        nav.appendChild(addBtn);
      }
    });

    // ===== VIEW & FILTERS =====
    function setViewMode(mode) {
      viewMode = mode;

      // Update Buttons
      document.getElementById('btn-month').classList.toggle('active', mode === 'month');
      document.getElementById('btn-all').classList.toggle('active', mode === 'all');

      // Toggle Elements
      const monthNav = document.getElementById('month-nav-container');
      const filterBar = document.getElementById('filter-bar');

      if (mode === 'month') {
        monthNav.style.display = 'flex';
        filterBar.style.display = 'none';
      } else {
        monthNav.style.display = 'none';
        filterBar.style.display = 'flex';
      }

      renderCalendar();
    }

    function populateFilters() {
      // Vehicles
      const vehicles = [...new Set(allLaunches.map(l => l.vehicle).filter(Boolean))].sort();
      const vSelect = document.getElementById('filter-vehicle');
      const currentV = vSelect.value;
      vSelect.innerHTML = '<option value="all">Todos</option>';
      vehicles.forEach(v => {
        const op = document.createElement('option');
        op.value = v;
        op.textContent = v;
        vSelect.appendChild(op);
      });
      vSelect.value = currentV;

      // Platforms (Sites)
      const sites = [...new Set(allLaunches.map(l => l.site).filter(Boolean))].sort();
      const sSelect = document.getElementById('filter-site');
      const currentS = sSelect.value;
      sSelect.innerHTML = '<option value="all">Todas</option>';
      sites.forEach(s => {
        const op = document.createElement('option');
        op.value = s;
        op.textContent = s;
        sSelect.appendChild(op);
      });
      sSelect.value = currentS;
    }

    // ===== AUTH =====
    function checkUser() {
      const loginBtn = document.getElementById('login-btn');
      if (currentUser) {
        loginBtn.textContent = 'Salir';
        loginBtn.onclick = logout;
        loginBtn.classList.add('ghost');
        loginBtn.classList.remove('primary');
      } else {
        loginBtn.textContent = 'Login';
        loginBtn.onclick = openAuthModal;
        loginBtn.classList.remove('ghost');
        loginBtn.classList.add('primary');
      }
    }

    function isAdmin() {
      return currentUser && ADMINS.includes(currentUser);
    }

    function openAuthModal(e) { if (e) e.preventDefault(); document.getElementById('auth-modal-overlay').classList.add('show'); }
    function closeAuthModal() { document.getElementById('auth-modal-overlay').classList.remove('show'); }

    function handleLogin(e) {
      e.preventDefault();
      const user = document.getElementById('login-username').value;
      const pass = document.getElementById('login-password').value; // Simple auth

      // In a real app use Firebase Auth. Here we stick to the existing simple check pattern
      if (user === 'Esstor' && pass) {
        currentUser = user;
        localStorage.setItem('esz_user', user);
        closeAuthModal();
        location.reload(); // Reload to apply admin UI
      } else {
        alert('Usuario desconocido');
      }
    }

    function logout() {
      localStorage.removeItem('esz_user');
      location.reload();
    }

    // ===== DATA =====
    function loadLaunches() {
      database.ref('events').on('value', snap => {
        const data = snap.val() || {};
        allLaunches = Object.keys(data).map(k => ({ id: k, ...data[k] }));
        // Sort by Date
        allLaunches.sort((a, b) => new Date(a.datetimeISO) - new Date(b.datetimeISO));

        populateFilters();
        renderCalendar();
      });
    }

    function changeMonth(delta) {
      if (viewMode !== 'month') return;
      currentDate.setMonth(currentDate.getMonth() + delta);
      renderCalendar();
    }

    function renderCalendar() {
      const monthIndex = currentDate.getMonth();
      const year = currentDate.getFullYear();

      // Update Title
      if (viewMode === 'month') {
        document.getElementById('month-display').innerHTML = `${monthNames[monthIndex]} <span class="month-year">${year}</span>`;
      }

      // Filter Logic
      const fStatus = document.getElementById('filter-status').value;
      const fVehicle = document.getElementById('filter-vehicle').value;
      const fSite = document.getElementById('filter-site').value;
      const fSearch = document.getElementById('filter-search').value.toLowerCase();

      const filtered = allLaunches.filter(l => {
        const d = new Date(l.datetimeISO);
        let match = true;

        // 1. View Mode Filter
        if (viewMode === 'month') {
          if (d.getMonth() !== monthIndex || d.getFullYear() !== year) match = false;
        }

        // 2. Filters
        if (viewMode === 'all') {
          if (fStatus !== 'all') {
            const now = new Date();

            // Explicit status checks
            if (fStatus === 'success' && l.status !== 'success') match = false;
            if (fStatus === 'failure' && l.status !== 'failure') match = false;

            // Upcoming / Past logic
            if (fStatus === 'upcoming') {
              if (l.status === 'success' || l.status === 'failure') match = false;
              else if (d < now && l.status !== 'upcoming') match = false; // If no status or status is not explicitly upcoming, use date
            }

            if (fStatus === 'past') {
              if (l.status === 'upcoming') match = false;
              // Past includes success/failure naturally, but if we strictly mean 'past pending' vs 'success', user filter has separate options.
              // Usually 'past' filter in this context means 'Realizados' (all past).
              // But if user selects 'Realizados', we generally show everything in the past. 
              // Let's assume 'Realizados' (past) should show success/failure too unless we want to split them?
              // Based on UI screenshot: Todos, Programados, Realizados, Exito, Fallo.
              // 'Realizados' probably means all past launches.
              if (d >= now && l.status !== 'success' && l.status !== 'failure') match = false;
            }
          }
          if (fVehicle !== 'all' && l.vehicle !== fVehicle) match = false;
          if (fSite !== 'all' && l.site !== fSite) match = false;
          if (fSearch && !l.mission.toLowerCase().includes(fSearch)) match = false;
        }

        return match;
      });

      // Apply Sort
      const fSort = document.getElementById('filter-sort') ? document.getElementById('filter-sort').value : 'asc';
      filtered.sort((a, b) => {
        const dateA = new Date(a.datetimeISO);
        const dateB = new Date(b.datetimeISO);
        return fSort === 'asc' ? dateA - dateB : dateB - dateA;
      });

      const grid = document.getElementById('launches-grid');
      grid.innerHTML = '';

      if (filtered.length === 0) {
        grid.innerHTML = '<div style="opacity:0.5; font-size:14px; grid-column:1/-1;">No hay lanzamientos que coincidan con los filtros.</div>';
        return;
      }

      const admin = isAdmin();

      filtered.forEach(launch => {
        const d = new Date(launch.datetimeISO);
        const day = String(d.getDate()).padStart(2, '0');
        const monthShort = monthNames[d.getMonth()];
        const time = d.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

        const card = document.createElement('div');
        card.className = 'card';
        // If image is present, use it. Else default gradient/color already in CSS
        if (launch.image) {
          card.style.backgroundImage = `url('${launch.image}')`;
        } else {
          card.style.backgroundImage = `url('background.jpg')`; // Fallback
        }

        let adminControls = '';
        if (admin) {
          adminControls = `
                <div style="position:absolute; top:10px; right:10px; z-index:10; display:flex; gap:5px;">
                    <button onclick="event.stopPropagation(); editLaunch('${launch.id}')" style="background:rgba(0,0,0,0.6); color:white; border:none; border-radius:4px; padding:4px 8px; cursor:pointer;">‚úèÔ∏è</button>
                    <button onclick="event.stopPropagation(); deleteLaunch('${launch.id}')" style="background:rgba(200,0,0,0.6); color:white; border:none; border-radius:4px; padding:4px 8px; cursor:pointer;">üóë</button>
                </div>
            `;
        }

        let statusBadge = '';
        if (launch.status === 'success') {
          statusBadge = '<div class="status-badge success">√âXITO</div>';
        } else if (launch.status === 'failure') {
          statusBadge = '<div class="status-badge failure">FALLO</div>';
        } else {
          statusBadge = '<div class="status-badge upcoming">PROGRAMADO</div>';
        }

        card.innerHTML = `
                ${adminControls}
                <div class="card-content">
                    <div class="date-badge">
                        <span class="date-day">${day}</span>
                        <span class="date-month">${monthShort}</span>
                    </div>

                    <div class="rocket-mission">
                        ${launch.vehicle || 'COHETE'} <span class="separator">‚Ä¢</span> ${launch.mission || 'MISI√ìN'}
                    </div>
                    ${statusBadge}

                    <div class="time-row">
                        <div class="launch-time">
                            üïí ${time}
                        </div>
                        <a href="#" class="timezone-btn">Ver en mi zona horaria</a>
                    </div>
                    
                    <div class="card-footer">
                        <div class="location-row">
                            <span>üìç</span>
                            <span>${launch.site || 'Ubicaci√≥n desconocida'}</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Proveedor de lanzamiento:</span>
                            <span style="font-weight:600">${launch.provider || 'EsZunSpace'}</span>
                        </div>
                         <div class="detail-item">
                            <span class="label">Veh√≠culo:</span>
                            <span style="font-weight:600">${launch.vehicle || '-'}</span>
                        </div>
                         <div class="detail-item">
                            <span class="label">Aterrizaje:</span>
                            <span style="font-weight:600">${launch.landing || 'Gasto'}</span>
                        </div>
                    </div>
                </div>
            `;

        card.onclick = () => openModal(launch);
        grid.appendChild(card);
      });
    }

    function openModal(launch) {
      const modal = document.getElementById('event-modal');
      const content = document.getElementById('modal-content');
      // Hide default title since we have a custom banner now
      document.getElementById('modal-title').style.display = 'none';

      // Utils
      const d = new Date(launch.datetimeISO);
      const dateStr = d.toLocaleString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }) + ' UTC'; // Assuming UTC for display implies local or Z

      // Calculate Countdown String (Static for now)
      let countdownStr = "T- 00 d 00 h 00 m 00 s";
      const now = new Date();
      const diff = d - now;
      if (diff > 0) {
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
        countdownStr = `${String(days).padStart(2, '0')} d ${String(hours).padStart(2, '0')} h ${String(minutes).padStart(2, '0')} m ${String(seconds).padStart(2, '0')} s`;
      } else {
        countdownStr = "Lanzamiento Realizado";
      }

      const statusMap = { 'upcoming': 'Programado', 'success': '√âxito', 'failure': 'Fallo', 'past': 'Realizado' };
      const statusLabel = statusMap[launch.status] || launch.status || 'Desconocido';

      // Auto-calculate Flight Number
      // Filter launches with same vehicle
      const vehicleLaunches = allLaunches.filter(l => l.vehicle === launch.vehicle);
      // Ensure sorted by Date (allLaunches is sorted, but filter maintains order)
      const sortedV = vehicleLaunches.sort((a, b) => new Date(a.datetimeISO) - new Date(b.datetimeISO));
      const flightIndex = sortedV.findIndex(l => l.id === launch.id);
      const calculatedFlightNum = flightIndex >= 0 ? (flightIndex + 1) : 'N/A';

      const bannerImg = launch.image || 'background.jpg';

      content.innerHTML = `
            <div class="modal-banner-container" style="background-image: url('${bannerImg}')">
                <div class="modal-banner-overlay">
                    <div class="modal-countdown">${countdownStr}</div>
                    <div class="modal-hero-title">
                        ${launch.vehicle || 'COHETE'} - VUELO #${calculatedFlightNum}
                    </div>
                </div>
            </div>



            <p class="modal-description">
                ${launch.description || 'El proveedor no ha facilitado una descripci√≥n detallada para esta misi√≥n.'}
            </p>

            <div class="details-grid">
                <div class="detail-box">
                    <h3>DETALLES DE MISI√ìN</h3>
                    <div class="detail-row">üïí <strong>Fecha y hora:</strong> ${dateStr}</div>
                    <div class="detail-row">üë§ <strong>Cliente:</strong> ${launch.client || 'N/D'}</div>
                    <div class="detail-row">üöÄ <strong>Destino:</strong> ${launch.orbit || 'N/D'}</div>
                    <div class="detail-row">üìç <strong>Ubicaci√≥n:</strong> ${launch.site || 'N/D'}</div>
                    <div class="detail-row">üë• <strong>Organizador:</strong> ${launch.provider || 'EsZunSpace'}</div>
                    <div class="detail-row">üì¶ <strong>Carga √∫til:</strong> ${launch.payload || 'N/D'}</div>
                    <div class="detail-row">üè∑Ô∏è <strong>Estado:</strong> ${statusLabel}</div>
                </div>

                <div class="detail-box">
                    <h3>DETALLES DEL COHETE</h3>
                    <div class="detail-row">üöÄ <strong>Cohete:</strong> ${launch.vehicle || 'N/D'}</div>
                    <div class="detail-row"># <strong>N¬∫ lanzamiento:</strong> ${calculatedFlightNum}</div>
                    <div class="detail-row">üõ¨ <strong>Aterrizaje:</strong> ${launch.landing || 'Gasto'}</div>
                </div>
            </div>

            <!-- Flight Plan Image -->
            <div style="margin-bottom: 25px; border-radius: 12px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1);">
                <img src="planvuelo.png" alt="Plan de Vuelo" style="width: 100%; display: block;">
            </div>

            <div class="footer-text">
                ${launch.footer_text || 'Como suele ser habitual en este tipo de lanzamientos, no hay informaci√≥n adicional disponible.'}
            </div>
        `;

      modal.classList.add('show');
    }

    // ===== STATS =====
    function openStatsModal() {
      const modal = document.getElementById('stats-modal-overlay');

      // Launch Stats
      let total = 0;
      let success = 0;
      let failure = 0;
      let upcoming = 0;

      // Landing Stats
      let lSuccess = 0;
      let lFailure = 0;

      allLaunches.forEach(l => {
        // Launch
        total++;
        if (l.status === 'success') success++;
        if (l.status === 'failure') failure++;
        if (l.status === 'upcoming' || l.status === 'programado') upcoming++;

        // Landing
        if (l.landing_status === 'success') lSuccess++;
        if (l.landing_status === 'failure') lFailure++;
      });

      // Calc Launch Rate
      const completed = success + failure;
      let successRate = 0;
      if (completed > 0) {
        successRate = Math.round((success / completed) * 100);
      }

      // Calc Landing Rate
      const lCompleted = lSuccess + lFailure;
      let lSuccessRate = 0;
      if (lCompleted > 0) {
        lSuccessRate = Math.round((lSuccess / lCompleted) * 100);
      }

      // DOM Updates
      document.getElementById('stat-total').innerText = total;
      document.getElementById('stat-success-count').innerText = success;
      document.getElementById('stat-failure-count').innerText = failure;
      document.getElementById('stat-upcoming').innerText = upcoming;
      document.getElementById('stat-percent').innerText = `${successRate}%`;

      // Update Landing Summaries
      if (document.getElementById('stat-landing-total')) {
        const lTotal = lSuccess + lFailure;
        document.getElementById('stat-landing-total').innerText = lTotal;
        document.getElementById('stat-landing-success').innerText = lSuccess;
        document.getElementById('stat-landing-failure').innerText = lFailure;
      }

      // Check if element exists before setting it (it should)
      const lPercentEl = document.getElementById('stat-landing-percent');
      if (lPercentEl) lPercentEl.innerText = `${lSuccessRate}%`;

      // Update Charts
      const chartLaunch = document.getElementById('chart-success');
      chartLaunch.style.background = `conic-gradient(#00e0ff 0% ${successRate}%, #ff0055 ${successRate}% 100%)`;

      const chartLanding = document.getElementById('chart-landing');
      if (chartLanding) {
        chartLanding.style.background = `conic-gradient(#00e0ff 0% ${lSuccessRate}%, #ff0055 ${lSuccessRate}% 100%)`;
      }

      modal.classList.add('show');
    }

    // ===== ADMIN ACTIONS =====
    function openAddLaunchModal() {
      document.getElementById('launch-id').value = '';
      document.getElementById('launch-modal-title').innerText = 'A√±adir Lanzamiento';

      // Defaults requested by user
      document.getElementById('launch-vehicle').value = 'V O R T I C';
      document.getElementById('launch-flight-num').value = ''; // Reset
      document.getElementById('launch-mission').value = '';
      document.getElementById('launch-client').value = ''; // Reset
      document.getElementById('launch-date').value = '';
      document.getElementById('launch-status').value = 'upcoming';
      document.getElementById('launch-site').value = 'LC-36A de Cabo Ca√±averal';
      document.getElementById('launch-orbit').value = ''; // Reset
      document.getElementById('launch-landing').value = 'EsZunBoat';
      document.getElementById('launch-landing-status').value = 'upcoming'; // Default
      document.getElementById('launch-provider').value = 'EsZunSpace';
      document.getElementById('launch-payload').value = ''; // Reset
      document.getElementById('launch-desc').value = '';
      document.getElementById('launch-footer-text').value = ''; // Reset

      document.getElementById('launch-image-base64').value = '';
      document.getElementById('launch-image-file').value = '';
      document.getElementById('image-preview').style.display = 'none';

      document.getElementById('launch-modal').classList.add('show');
    }

    function closeLaunchModal() {
      document.getElementById('launch-modal').classList.remove('show');
    }

    function editLaunch(id) {
      const launch = allLaunches.find(l => l.id === id);
      if (!launch) return;

      document.getElementById('launch-id').value = id;
      document.getElementById('launch-modal-title').innerText = 'Editar Lanzamiento';

      document.getElementById('launch-vehicle').value = launch.vehicle || '';
      document.getElementById('launch-flight-num').value = launch.flight_number || '';
      document.getElementById('launch-mission').value = launch.mission || '';
      document.getElementById('launch-client').value = launch.client || '';
      document.getElementById('launch-date').value = launch.datetimeISO || '';
      document.getElementById('launch-status').value = launch.status || 'upcoming';
      document.getElementById('launch-site').value = launch.site || '';
      document.getElementById('launch-orbit').value = launch.orbit || '';
      document.getElementById('launch-provider').value = launch.provider || '';
      document.getElementById('launch-landing').value = launch.landing || '';
      document.getElementById('launch-landing-status').value = launch.landing_status || 'na';
      document.getElementById('launch-payload').value = launch.payload || '';
      document.getElementById('launch-desc').value = launch.description || '';
      document.getElementById('launch-footer-text').value = launch.footer_text || '';

      if (launch.image) {
        const prev = document.getElementById('image-preview');
        prev.style.backgroundImage = `url('${launch.image}')`;
        prev.style.display = 'block';
        document.getElementById('launch-image-base64').value = launch.image;
      } else {
        document.getElementById('image-preview').style.display = 'none';
      }

      document.getElementById('launch-modal').classList.add('show');
    }

    // Image Handling
    const fileInput = document.getElementById('launch-image-file');
    if (fileInput) {
      fileInput.addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (!file) return;

        if (file.size > 1024 * 1024) { // 1MB limit check
          alert('La imagen es muy grande. Se recomienda menos de 1MB.');
        }

        const reader = new FileReader();
        reader.onloadend = function () {
          const base64 = reader.result;
          document.getElementById('launch-image-base64').value = base64;
          const prev = document.getElementById('image-preview');
          prev.style.backgroundImage = `url('${base64}')`;
          prev.style.display = 'block';
        }
        reader.readAsDataURL(file);
      });
    }

    async function saveLaunch(e) {
      e.preventDefault();
      const id = document.getElementById('launch-id').value;
      const data = {
        vehicle: document.getElementById('launch-vehicle').value,
        flight_number: document.getElementById('launch-flight-num').value,
        mission: document.getElementById('launch-mission').value,
        client: document.getElementById('launch-client').value,
        datetimeISO: document.getElementById('launch-date').value,
        status: document.getElementById('launch-status').value,
        site: document.getElementById('launch-site').value,
        orbit: document.getElementById('launch-orbit').value,
        provider: document.getElementById('launch-provider').value,
        landing: document.getElementById('launch-landing').value,
        landing_status: document.getElementById('launch-landing-status').value, // Save landing status
        payload: document.getElementById('launch-payload').value,
        description: document.getElementById('launch-desc').value,
        footer_text: document.getElementById('launch-footer-text').value,
        image: document.getElementById('launch-image-base64').value
      };

      try {
        if (id) {
          // Update
          await database.ref('events/' + id).update(data);
        } else {
          // Create
          await database.ref('events').push(data);
        }
        closeLaunchModal();
        // Calendar updates via on('value') listener
      } catch (err) {
        console.error(err);
        alert('Error al guardar: ' + err.message);
      }
    }

    async function deleteLaunch(id) {
      if (confirm('¬øSeguro que quieres eliminar este lanzamiento?')) {
        await database.ref('events/' + id).remove();
      }
    }
  </script>
</body>

</html>