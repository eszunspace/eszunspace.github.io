<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MOTORES – EsZunSpace</title>
  <meta name="description" content="Detalles técnicos de los motores de EsZunSpace.">
  <link rel="icon" type="image/jpeg" href="logoarriba.jpg">

  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Space+Grotesk:wght@500;700&display=swap"
    rel="stylesheet">

  <!-- Firebase SDK (needed for header auth logic if we want to keep it working) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <style>
    :root {
      --bg-image: url('background.jpg');
      --header-h: 64px;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      margin: 0;
    }

    body {
      font-family: 'Poppins', system-ui, sans-serif;
      color: #fff;
      background: #000;
      opacity: 0;
      transition: opacity 0.6s ease;
      background-image: var(--bg-image);
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }

    body.fade-in {
      opacity: 1;
    }

    body.fade-out {
      opacity: 0;
    }

    /* ===== Header cápsula con marcador activo ===== */
    header.topbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      padding: 12px 12px;
      background: linear-gradient(180deg, rgba(0, 0, 0, .65) 0%, rgba(0, 0, 0, 0) 100%);
      -webkit-backdrop-filter: blur(2px);
      backdrop-filter: blur(2px);
    }

    .nav-shell {
      width: min(1200px, 94vw);
      margin: 0 auto;
      height: var(--header-h);
      padding: 0 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.07), rgba(255, 255, 255, 0.03));
      border: 1px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 10px 30px rgba(0, 0, 0, .6);
      position: relative;
      overflow: hidden;
    }

    .nav-shell::before {
      content: "";
      position: absolute;
      inset: -1px;
      background: conic-gradient(from 0deg, #00f0ff, #ff00d4, #00f0ff);
      filter: blur(22px);
      opacity: .14;
      pointer-events: none;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: #fff;
      min-width: 0;
    }

    .brand img {
      height: 36px;
      width: 36px;
      border-radius: 50%;
      box-shadow: 0 0 8px rgba(255, 255, 255, .1)
    }

    .brand .title {
      font-family: 'Space Grotesk', system-ui, sans-serif;
      font-weight: 800;
      letter-spacing: .02em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* === Toggle (mobile) === */
    .menu-toggle {
      display: none;
      background: transparent;
      border: 0;
      color: #fff;
      width: 44px;
      height: 44px;
      border-radius: 12px;
    }

    .menu-toggle:focus-visible {
      outline: 2px solid #00f0ff;
      outline-offset: 2px;
    }

    .menu {
      display: flex;
      align-items: center;
      gap: 18px
    }

    .menu a {
      position: relative;
      display: inline-flex;
      align-items: center;
      padding: 10px 10px;
      text-decoration: none;
      color: #fff;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .08em;
      font-size: 12px;
      opacity: .9;
      transition: opacity .2s ease;
      -webkit-tap-highlight-color: transparent;
    }

    .menu a:hover {
      opacity: 1
    }

    .menu a::after {
      content: "";
      position: absolute;
      left: 12px;
      right: 12px;
      bottom: 6px;
      height: 2px;
      background: linear-gradient(90deg, #00f0ff, #ff00d4);
      transform: scaleX(0);
      transform-origin: left;
      transition: transform .25s ease;
      border-radius: 2px;
    }

    .menu a:hover::after {
      transform: scaleX(1);
    }

    .menu a[aria-current="page"] {
      opacity: 1
    }

    .menu a[aria-current="page"]::after {
      transform: scaleX(1);
    }

    /* User section */
    .user-section {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 10px;
      background: rgba(255, 255, 255, .06);
      border: 1px solid rgba(255, 255, 255, .18);
      cursor: pointer;
      transition: transform .15s ease, background .2s ease, border-color .2s ease;
    }

    .user-info:hover {
      transform: translateY(-1px);
      background: rgba(255, 255, 255, .1);
      border-color: rgba(255, 255, 255, .3);
    }

    .user-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: linear-gradient(135deg, #00f0ff, #ff00d4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 12px;
    }

    .user-name {
      font-weight: 600;
      font-size: 13px;
    }

    /* Mobile: user section in header */
    @media (max-width: 900px) {
      .user-section #user-display .user-info {
        padding: 4px 8px;
      }

      .user-section #user-display .user-avatar {
        width: 32px;
        height: 32px;
        font-size: 14px;
      }

      .user-section #user-display .user-name {
        display: none;
      }

      .user-section #login-btn {
        padding: 0 12px;
        font-size: 12px;
        height: 36px;
      }
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 32px;
      min-width: 32px;
      padding: 0 10px;
      border-radius: 10px;
      background: rgba(255, 255, 255, .06);
      border: 1px solid rgba(255, 255, 255, .18);
      color: #fff;
      cursor: pointer;
      user-select: none;
      transition: transform .15s ease, background .2s ease, border-color .2s ease;
      text-decoration: none;
      gap: 8px;
      font-family: inherit;
      font-size: 13px;
    }

    .btn:hover {
      transform: translateY(-1px);
      background: rgba(255, 255, 255, .1);
      border-color: rgba(255, 255, 255, .3)
    }

    .btn.primary {
      border: 0;
      background: linear-gradient(90deg, #00f0ff, #ff00d4);
      font-weight: 700;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .35);
    }

    .btn.ghost {
      background: rgba(255, 255, 255, .06);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 18px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .modal-overlay.show {
      display: flex;
      animation: fadeIn 0.3s ease forwards;
    }

    .modal-card {
      width: min(680px, 96vw);
      border-radius: 18px;
      background: radial-gradient(1200px 1200px at -10% -20%, rgba(0, 240, 255, .08), transparent 35%), #111113;
      border: 1px solid rgba(255, 255, 255, .12);
      box-shadow: 0 28px 80px rgba(0, 0, 0, .6), inset 0 1px 0 rgba(255, 255, 255, .06);
      padding: 18px 18px 16px;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.9) translateY(20px);
      opacity: 0;
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease;
    }

    .modal-overlay.show .modal-card {
      transform: scale(1) translateY(0);
      opacity: 1;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .modal-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .modal-title {
      margin: 0;
      font-family: 'Space Grotesk', system-ui, sans-serif;
      font-size: 1.15rem;
      letter-spacing: .2px;
      font-weight: 700;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-top: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-group label {
      font-weight: 600;
      font-size: 14px;
    }

    .form-group input {
      padding: 12px 14px;
      border-radius: 10px;
      background: rgba(255, 255, 255, .06);
      border: 1px solid rgba(255, 255, 255, .18);
      color: #fff;
      font-size: 14px;
      font-family: inherit;
      transition: border-color .2s ease, background .2s ease;
    }

    .form-group input:focus {
      outline: none;
      border-color: #00f0ff;
      background: rgba(255, 255, 255, .08);
    }

    .error-msg {
      color: #ff6b6b;
      font-size: 13px;
      margin-top: 4px;
      display: none;
    }

    .error-msg.show {
      display: block;
    }

    .success-msg {
      color: #51cf66;
      font-size: 13px;
      margin-top: 4px;
      display: none;
    }

    .success-msg.show {
      display: block;
    }

    .toggle-form {
      text-align: center;
      margin-top: 16px;
      color: rgba(255, 255, 255, .72);
      font-size: 14px;
    }

    .toggle-form a {
      color: #00f0ff;
      text-decoration: none;
      font-weight: 600;
      transition: opacity .2s ease;
    }

    .toggle-form a:hover {
      opacity: .8
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    /* =========================
       Responsive
       ========================= */
    @media (max-width: 900px) {
      :root {
        --header-h: 56px;
      }

      .brand img {
        width: 32px;
        height: 32px;
      }

      .nav-shell {
        padding: 0 10px;
        border-radius: 14px;
      }

      .menu-toggle {
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .menu {
        position: fixed;
        inset: calc(var(--header-h) + 8px) 8px auto 8px;
        right: 8px;
        left: 8px;
        top: calc(var(--header-h) + 12px);
        display: none;
        flex-direction: column;
        align-items: stretch;
        gap: 6px;
        padding: 10px;
        background: rgba(18, 18, 18, 0.92);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 16px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, .6);
        backdrop-filter: blur(8px);
      }

      .menu.open {
        display: flex;
      }

      .menu a {
        padding: 14px 12px;
        font-size: 13px;
        letter-spacing: .12em;
        border-radius: 10px;
      }

      .menu a::after {
        display: none;
      }

      .brand .title {
        font-size: 16px;
      }

      .user-section {
        display: flex;
      }

      .user-section .btn.ghost {
        display: none;
      }
    }

    @media (hover:none) {
      .menu a:hover::after {
        transform: none;
      }

      .menu a:hover {
        opacity: 1;
      }
    }

    /* Accesibilidad: respetar reduce-motion */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation: none !important;
        transition: none !important;
      }
    }

    /* ===== Full Screen Engine Display ===== */
    main {
      position: fixed;
      inset: 0;
      padding-top: calc(var(--header-h) + 24px);
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #0a0a0f 0%, #0d0d15 50%, #0a0a0f 100%);
    }

    .engine-page {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      position: relative;
      max-width: 1600px;
      margin: 0 auto;
      padding: 0 60px;
    }

    /* Left: Info Panel */
    .engine-info {
      flex: 0 0 45%;
      max-width: 500px;
      z-index: 10;
    }

    .engine-title {
      font-family: 'Space Grotesk', sans-serif;
      font-weight: 700;
      font-size: clamp(32px, 5vw, 56px);
      letter-spacing: 0.05em;
      text-transform: uppercase;
      margin: 0 0 12px;
      color: #fff;
    }

    .engine-subtitle {
      display: flex;
      gap: 24px;
      margin-bottom: 32px;
    }

    .engine-subtitle span {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: rgba(255, 255, 255, 0.5);
      cursor: pointer;
      transition: color 0.2s;
    }

    .engine-subtitle span.active {
      color: #fff;
    }

    .engine-subtitle span:hover {
      color: rgba(255, 255, 255, 0.8);
    }

    .engine-desc {
      font-size: 14px;
      line-height: 1.8;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 40px;
      max-width: 450px;
    }

    /* Specs Table */
    .specs-table {
      width: 100%;
      max-width: 450px;
    }

    .spec-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .spec-row:last-child {
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .spec-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.15em;
      color: rgba(255, 255, 255, 0.5);
    }

    .spec-value {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 14px;
      font-weight: 600;
      color: #fff;
    }

    .spec-value .highlight {
      color: #ff4d00;
    }

    /* Right: 3D Viewer */
    .engine-visual {
      position: absolute;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 55%;
      height: 90%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #engine-3d-container {
      width: 100%;
      height: 100%;
      border-radius: 0;
      background: transparent;
      position: relative;
      transition: opacity 0.4s ease;
    }

    #engine-3d-container.fading {
      opacity: 0;
    }

    .engine-transition-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at center, rgba(0, 240, 255, 0.1) 0%, transparent 70%);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 5;
    }

    .engine-transition-overlay.active {
      opacity: 1;
    }

    /* Navigation Arrows */
    .nav-arrow {
      position: fixed;
      top: 50%;
      transform: translateY(-50%);
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: none;
      color: rgba(255, 255, 255, 0.5);
      font-size: 32px;
      cursor: pointer;
      transition: color 0.2s;
      z-index: 20;
    }

    .nav-arrow:hover {
      color: #fff;
    }

    .nav-arrow.prev {
      left: 20px;
    }

    .nav-arrow.next {
      right: 20px;
    }

    /* Page Dots */
    .page-dots {
      position: fixed;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 12px;
      z-index: 20;
    }

    .page-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      cursor: pointer;
      transition: background 0.2s;
    }

    .page-dot.active {
      background: #fff;
    }

    .page-dot:hover {
      background: rgba(255, 255, 255, 0.6);
    }

    /* Footer hidden */
    footer {
      display: none;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .engine-page {
        flex-direction: column;
        padding: 20px;
        padding-top: 20px;
      }

      .engine-info {
        flex: 0 0 auto;
        max-width: 100%;
        text-align: center;
        order: 2;
      }

      .engine-subtitle {
        justify-content: center;
      }

      .engine-desc {
        margin-left: auto;
        margin-right: auto;
      }

      .specs-table {
        margin: 0 auto;
      }

      .engine-visual {
        position: relative;
        right: auto;
        top: auto;
        transform: none;
        width: 100%;
        height: 40vh;
        order: 1;
        margin-bottom: 20px;
      }

      .nav-arrow {
        display: none;
      }
    }

    @media (max-width: 600px) {
      .engine-title {
        font-size: 28px;
      }

      .engine-desc {
        font-size: 13px;
        margin-bottom: 24px;
      }

      .spec-row {
        padding: 12px 0;
      }

      .engine-visual {
        height: 35vh;
      }
    }
  </style>
</head>

<body>

  <header class="topbar">
    <div class="nav-shell">
      <a class="brand" href="index.html" aria-label="Ir a inicio">
        <img src="logoarriba.jpg" alt="Logo de EsZunSpace">
        <span class="title">EsZunSpace</span>
      </a>

      <!-- Toggle sólo visible en móvil -->
      <button class="menu-toggle" aria-controls="primary-menu" aria-expanded="false" aria-label="Abrir menú">
        <svg width="24" height="24" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>
      </button>

      <nav id="primary-menu" class="menu" role="navigation" aria-label="Menú principal">
        <a href="calendario.html">Calendario</a>
        <a href="cohetes.html">Cohetes</a>
        <a href="motores.html">Motores</a>
        <a href="satelites.html">Satélites</a>
        <a href="lanzamientos.html">Lanzamientos</a>
        <a href="stream.html">Stream</a>
        <div id="mobile-logout-section"
          style="display:none; margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,.12);">
          <button class="btn ghost" onclick="logout()" style="width:100%; justify-content:center;">Cerrar
            sesión</button>
        </div>
      </nav>

      <div class="user-section">
        <div id="user-display" style="display:none;">
          <div class="user-info" onclick="showProfileModal()" role="button" tabindex="0" aria-label="Ver perfil">
            <div class="user-avatar" id="user-avatar">U</div>
            <span class="user-name" id="user-name">Usuario</span>
          </div>
          <button class="btn ghost" onclick="logout()">Salir</button>
        </div>
        <button id="login-btn" class="btn primary" onclick="showLoginModal()">Iniciar sesión</button>
      </div>
    </div>
  </header>

  <main>
    <div class="engine-page">
      <!-- Left: Info Panel -->
      <div class="engine-info">
        <h1 class="engine-title" id="engine-title">EsZunEngine 1</h1>

        <div class="engine-subtitle">
          <span class="active" onclick="switchEngine('stage1')" id="tab-stage1">PRIMERA ETAPA</span>
          <span onclick="switchEngine('vacuum')" id="tab-vacuum">SEGUNDA ETAPA (VAC)</span>
        </div>

        <p class="engine-desc" id="engine-desc">
          El EsZunEngine 1 es un motor de combustión de hidrógeno-oxígeno líquido reutilizable
          que impulsa el cohete VORTIC. Con un empuje de 2279 kN en vacío, es capaz de propulsar
          la primera etapa del VORTIC con 7 motores en la base central y optimizando el rendimiento
          para la recuperación del booster.
        </p>

        <div class="specs-table" id="specs-table">
          <!-- Specs will be populated by JS -->
        </div>
      </div>

      <!-- Right: 3D Viewer -->
      <div class="engine-visual">
        <div id="engine-3d-container"></div>
      </div>
    </div>

    <!-- Navigation Arrows -->
    <button class="nav-arrow prev" onclick="switchEngine('stage1')">‹</button>
    <button class="nav-arrow next" onclick="switchEngine('vacuum')">›</button>

    <!-- Page Dots -->
    <div class="page-dots">
      <div class="page-dot active" id="dot-stage1" onclick="switchEngine('stage1')"></div>
      <div class="page-dot" id="dot-vacuum" onclick="switchEngine('vacuum')"></div>
    </div>
  </main>

  <!-- Three.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

  <script>
    // ===== ENGINE DATA =====
    const enginesData = {
      stage1: {
        title: 'EsZunEngine 1',
        desc: 'El EsZunEngine 1 es un motor de combustión de hidrógeno-oxígeno líquido reutilizable que impulsa el cohete VORTIC. Con un empuje de 2279 kN en vacío, es capaz de propulsar la primera etapa del VORTIC con 7 motores en la base central y optimizando el rendimiento para la recuperación del booster.',
        model: 'rs-25_engine.glb',
        specs: [
          { label: 'MASA', value: '3.5 t' },
          { label: 'EMPUJE (ASL)', value: '1845.4 kN' },
          { label: 'EMPUJE (VAC)', value: '<span class="highlight">2279.0 kN</span>' },
          { label: 'ISP', value: '366 s (ASL) / 452 s (Vac)' },
          { label: 'GIMBAL', value: '10.50°' },
          { label: 'PROPELENTES', value: 'LH2 / LOX' }
        ]
      },
      vacuum: {
        title: 'EsZunEngine 1 Vac',
        desc: 'Motor criogénico de alta presión optimizado para operación en vacío. Con una tobera extendida desplegable, ofrece un ISP excepcional de 1710 segundos en vacío. Diseñado para la segunda etapa del VORTIC, proporciona un empuje eficiente para la inserción orbital.',
        model: 'segunda.glb',
        specs: [
          { label: 'MASA', value: '1.0 t' },
          { label: 'EMPUJE (ASL)', value: '432.7 kN' },
          { label: 'EMPUJE (VAC)', value: '<span class="highlight">740.0 kN</span>' },
          { label: 'ISP', value: '1000 s (ASL) / 1710 s (Vac)' },
          { label: 'GIMBAL', value: '7.00°' },
          { label: 'PROPELENTES', value: 'LH2 / LOX' }
        ]
      }
    };

    let currentEngine = 'stage1';
    let currentModel = null;
    let scene, camera, renderer, controls, loader;

    // ===== 3D ENGINE VIEWER =====
    (function () {
      const container = document.getElementById('engine-3d-container');
      if (!container) return;

      // Scene setup
      scene = new THREE.Scene();

      // Camera
      camera = new THREE.PerspectiveCamera(40, container.clientWidth / container.clientHeight, 0.1, 1000);
      camera.position.set(0, 0.3, 3);

      // Renderer with transparency
      renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setClearColor(0x000000, 0);
      renderer.setSize(container.clientWidth, container.clientHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      renderer.outputEncoding = THREE.sRGBEncoding;
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      renderer.toneMappingExposure = 1.5;
      container.appendChild(renderer.domElement);

      // Controls
      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.autoRotate = true;
      controls.autoRotateSpeed = 1.5;
      controls.minDistance = 1;
      controls.maxDistance = 5;
      controls.target.set(0, 0.3, 0);

      // Lighting
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
      scene.add(ambientLight);

      const mainLight = new THREE.DirectionalLight(0xffffff, 1.2);
      mainLight.position.set(5, 5, 5);
      scene.add(mainLight);

      const fillLight = new THREE.DirectionalLight(0x00f0ff, 0.3);
      fillLight.position.set(-3, 2, -3);
      scene.add(fillLight);

      const rimLight = new THREE.DirectionalLight(0xff00d4, 0.2);
      rimLight.position.set(0, -2, -3);
      scene.add(rimLight);

      // Loader
      loader = new THREE.GLTFLoader();

      // Animation loop
      function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
      }
      animate();

      // Handle resize
      window.addEventListener('resize', () => {
        const width = container.clientWidth;
        const height = container.clientHeight;
        camera.aspect = width / height;
        camera.updateProjectionMatrix();
        renderer.setSize(width, height);
      });

      // Pause auto-rotate on interaction
      container.addEventListener('pointerdown', () => {
        controls.autoRotate = false;
      });

      let resumeTimeout;
      container.addEventListener('pointerup', () => {
        clearTimeout(resumeTimeout);
        resumeTimeout = setTimeout(() => {
          controls.autoRotate = true;
        }, 3000);
      });

      // Load initial engine
      loadEngine('stage1');
    })();

    // ===== LOAD ENGINE =====
    function loadEngine(engineId) {
      const data = enginesData[engineId];
      if (!data) return;

      const container = document.getElementById('engine-3d-container');

      // Start fade out transition
      container.classList.add('fading');

      // Wait for fade out, then load new model
      setTimeout(() => {
        // Clear ALL models from scene (keep only lights)
        const objectsToRemove = [];
        scene.traverse((child) => {
          if (child.isMesh || child.isGroup) {
            objectsToRemove.push(child);
          }
        });

        objectsToRemove.forEach((obj) => {
          if (obj.geometry) obj.geometry.dispose();
          if (obj.material) {
            if (Array.isArray(obj.material)) {
              obj.material.forEach(mat => mat.dispose());
            } else {
              obj.material.dispose();
            }
          }
          if (obj.parent) obj.parent.remove(obj);
        });

        currentModel = null;

        // Loading indicator
        let loadingDiv = container.querySelector('.loading-indicator');
        if (!loadingDiv) {
          loadingDiv = document.createElement('div');
          loadingDiv.className = 'loading-indicator';
          loadingDiv.style.cssText = 'position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#00f0ff;font-size:14px;z-index:10;';
          container.appendChild(loadingDiv);
        }
        loadingDiv.textContent = 'Cargando...';
        loadingDiv.style.display = 'block';
        loadingDiv.style.color = '#00f0ff';

        loader.load(
          data.model,
          (gltf) => {
            currentModel = gltf.scene;

            // Center and scale
            const box = new THREE.Box3().setFromObject(currentModel);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            const maxDim = Math.max(size.x, size.y, size.z);
            const scale = 1.5 / maxDim;
            currentModel.scale.setScalar(scale);

            currentModel.position.x = -center.x * scale;
            currentModel.position.y = -center.y * scale + 0.3;
            currentModel.position.z = -center.z * scale;

            scene.add(currentModel);
            loadingDiv.style.display = 'none';

            // Fade in the new model
            setTimeout(() => {
              container.classList.remove('fading');
            }, 100);
          },
          (progress) => {
            if (progress.total > 0) {
              const percent = Math.round((progress.loaded / progress.total) * 100);
              loadingDiv.textContent = `${percent}%`;
            }
          },
          (error) => {
            console.error('Error loading model:', error);
            loadingDiv.textContent = '❌ Error';
            loadingDiv.style.color = '#ff6b6b';
            container.classList.remove('fading');
          }
        );
      }, 400); // Wait for fade out animation
    }

    // ===== SWITCH ENGINE =====
    window.switchEngine = function (engineId, force = false) {
      if (!force && engineId === currentEngine) return;
      currentEngine = engineId;

      const data = enginesData[engineId];
      if (!data) return;

      // Update title
      document.getElementById('engine-title').textContent = data.title;

      // Update description
      document.getElementById('engine-desc').textContent = data.desc;

      // Update specs
      const specsTable = document.getElementById('specs-table');
      specsTable.innerHTML = data.specs.map(spec => `
        <div class="spec-row">
          <span class="spec-label">${spec.label}</span>
          <span class="spec-value">${spec.value}</span>
        </div>
      `).join('');

      // Update tabs
      document.getElementById('tab-stage1').classList.toggle('active', engineId === 'stage1');
      document.getElementById('tab-vacuum').classList.toggle('active', engineId === 'vacuum');

      // Update dots
      document.getElementById('dot-stage1').classList.toggle('active', engineId === 'stage1');
      document.getElementById('dot-vacuum').classList.toggle('active', engineId === 'vacuum');

      // Load 3D model
      loadEngine(engineId);
    };

    // Initialize specs on load
    document.addEventListener('DOMContentLoaded', () => {
      switchEngine('stage1', true); // Force initial load
    });
  </script>

  <footer>© <span id="year">2025</span> EsZunSpace – Todos los derechos reservados</footer>

  <!-- Login/Register Modal -->
  <div id="auth-modal-overlay" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card" role="document">
      <div class="modal-head">
        <h3 id="auth-modal-title" class="modal-title">Iniciar sesión</h3>
        <button class="btn ghost" onclick="closeAuthModal()" aria-label="Cerrar">✕</button>
      </div>

      <!-- Login Form -->
      <form id="login-form" class="login-form" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label for="login-username">Usuario</label>
          <input type="text" id="login-username" name="username" required autocomplete="username">
        </div>
        <div class="form-group">
          <label for="login-password">Contraseña</label>
          <input type="password" id="login-password" name="password" required autocomplete="current-password">
          <div id="login-error" class="error-msg">Usuario o contraseña incorrectos</div>
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn primary">Entrar</button>
          <button type="button" class="btn ghost" onclick="closeAuthModal()">Cancelar</button>
        </div>
        <div class="toggle-form">
          ¿No tienes cuenta? <a href="javascript:void(0)" onclick="showRegisterForm(event)">Crear cuenta</a>
        </div>
      </form>

      <!-- Register Form -->
      <form id="register-form" class="login-form" style="display:none;" onsubmit="handleRegister(event)">
        <div class="form-group">
          <label for="register-username">Usuario</label>
          <input type="text" id="register-username" name="username" required autocomplete="username">
          <div id="register-username-error" class="error-msg">Este nombre de usuario ya está en uso</div>
        </div>
        <div class="form-group">
          <label for="register-password">Contraseña</label>
          <input type="password" id="register-password" name="password" required autocomplete="new-password"
            minlength="6">
          <div id="register-error" class="error-msg">Error al crear la cuenta</div>
          <div id="register-success" class="success-msg">¡Cuenta creada! Iniciando sesión...</div>
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn primary">Crear cuenta</button>
          <button type="button" class="btn ghost" onclick="closeAuthModal()">Cancelar</button>
        </div>
        <div class="toggle-form">
          ¿Ya tienes cuenta? <a href="javascript:void(0)" onclick="showLoginForm(event)">Iniciar sesión</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profile-modal-overlay" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card" role="document">
      <div class="modal-head">
        <h3 class="modal-title">Mi Perfil</h3>
        <button class="btn ghost" onclick="closeProfileModal()" aria-label="Cerrar">✕</button>
      </div>

      <div style="margin-top:20px;">
        <div class="user-info" style="justify-content:center; padding:16px; cursor:default;">
          <div class="user-avatar" id="profile-avatar" style="width:48px; height:48px; font-size:20px;">U</div>
          <span class="user-name" id="profile-username" style="font-size:18px;">Usuario</span>
        </div>

        <!-- Change Username Form -->
        <form id="change-username-form" class="login-form" style="margin-top:24px;"
          onsubmit="handleChangeUsername(event)">
          <div class="form-group">
            <label for="new-username">Nuevo nombre de usuario</label>
            <input type="text" id="new-username" name="username" required autocomplete="username">
            <div id="username-change-error" class="error-msg">Este nombre de usuario ya está en uso</div>
            <div id="username-change-success" class="success-msg">¡Nombre de usuario actualizado!</div>
          </div>
          <div class="modal-actions">
            <button type="submit" class="btn primary">Cambiar nombre</button>
          </div>
        </form>

        <!-- Change Password Form -->
        <form id="change-password-form" class="login-form" style="margin-top:16px;"
          onsubmit="handleChangePassword(event)">
          <div class="form-group">
            <label for="current-password">Contraseña actual</label>
            <input type="password" id="current-password" name="current-password" required
              autocomplete="current-password">
          </div>
          <div class="form-group">
            <label for="new-password">Nueva contraseña</label>
            <input type="password" id="new-password" name="new-password" required autocomplete="new-password"
              minlength="6">
            <div id="password-change-error" class="error-msg">Contraseña actual incorrecta</div>
            <div id="password-change-success" class="success-msg">¡Contraseña actualizada!</div>
          </div>
          <div class="modal-actions">
            <button type="submit" class="btn primary">Cambiar contraseña</button>
          </div>
        </form>

        <div style="margin-top:24px; padding-top:16px; border-top:1px solid rgba(255,255,255,.12);">
          <button class="btn ghost" onclick="deleteAccount()" style="color:#ff6b6b; width:100%;">Eliminar
            cuenta</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIGURACIÓN DE FIREBASE =====
    const firebaseConfig = {
      apiKey: "AIzaSyDKvGLsd1jKfsSlzgTjBas-8WvbFqV1xU",
      authDomain: "eszunspace-bc900.firebaseapp.com",
      databaseURL: "https://eszunspace-bc900-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "eszunspace-bc900",
      storageBucket: "eszunspace-bc900.firebasestorage.app",
      messagingSenderId: "105651684829",
      appId: "1:105651684829:web:5c8fd5051c8c2daf24f744",
      measurementId: "G-ZDM5GF0MBW"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // ===== SHA-256 HASHING HELPER =====
    async function hashPassword(message) {
      const msgBuffer = new TextEncoder().encode(message);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      return hashHex;
    }

    let currentUser = null;
    let allUsers = {};
    const SESSION_KEY = 'esz_user';

    function hydrateSessionFromStorage() {
      const saved = localStorage.getItem(SESSION_KEY);
      currentUser = (saved && saved.trim()) ? saved : null;
      checkAuth();
    }

    window.addEventListener('storage', (e) => {
      if (e.key === SESSION_KEY) {
        hydrateSessionFromStorage();
      }
    });

    async function loadUsers() {
      try {
        const snapshot = await database.ref('users').once('value');
        allUsers = snapshot.val() || {};
      } catch (error) {
        console.error('Error al cargar usuarios:', error);
        allUsers = {};
      }
    }

    async function saveUser(username, password) {
      try {
        const snapshot = await database.ref('users/' + username).once('value');
        if (snapshot.exists()) {
          return false;
        }
        await database.ref('users/' + username).set(password);
        allUsers[username] = password;
        return true;
      } catch (error) {
        console.error('Error al guardar usuario:', error);
        return false;
      }
    }

    function checkAuth() {
      if (currentUser) {
        document.getElementById('login-btn').style.display = 'none';
        document.getElementById('user-display').style.display = 'flex';
        document.getElementById('user-name').textContent = currentUser;
        document.getElementById('user-avatar').textContent = currentUser.charAt(0).toUpperCase();
      } else {
        document.getElementById('login-btn').style.display = 'inline-flex';
        document.getElementById('user-display').style.display = 'none';
      }
    }

    function showLoginModal() {
      showLoginForm();
      const modal = document.getElementById('auth-modal-overlay');
      modal.style.display = 'flex';
      requestAnimationFrame(() => {
        modal.classList.add('show');
      });
    }

    function closeAuthModal() {
      const modal = document.getElementById('auth-modal-overlay');
      modal.classList.remove('show');
      setTimeout(() => {
        modal.style.display = 'none';
      }, 300);
      document.getElementById('login-error').classList.remove('show');
      document.getElementById('register-error').classList.remove('show');
      document.getElementById('register-username-error').classList.remove('show');
      document.getElementById('register-success').classList.remove('show');
    }

    function showLoginForm(e) {
      if (e) e.preventDefault();
      document.getElementById('auth-modal-title').textContent = 'Iniciar sesión';
      document.getElementById('login-form').style.display = 'flex';
      document.getElementById('register-form').style.display = 'none';
      document.getElementById('login-username').value = '';
      document.getElementById('login-password').value = '';
      document.getElementById('login-error').classList.remove('show');
    }

    function showRegisterForm(e) {
      if (e) e.preventDefault();
      document.getElementById('auth-modal-title').textContent = 'Crear cuenta';
      document.getElementById('login-form').style.display = 'none';
      document.getElementById('register-form').style.display = 'flex';
      document.getElementById('register-username').value = '';
      document.getElementById('register-password').value = '';
      document.getElementById('register-error').classList.remove('show');
      document.getElementById('register-username-error').classList.remove('show');
      document.getElementById('register-success').classList.remove('show');
    }

    async function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;
      const errEl = document.getElementById('login-error');

      if (!allUsers[username]) {
        errEl.textContent = 'Usuario no encontrado';
        errEl.classList.add('show');
        return;
      }

      const storedPassword = allUsers[username];

      if (storedPassword === password) {
        currentUser = username;
        localStorage.setItem(SESSION_KEY, currentUser);
        checkAuth();
        closeAuthModal();
      } else {
        errEl.textContent = 'Contraseña incorrecta';
        errEl.classList.add('show');
      }
    }

    async function handleRegister(e) {
      e.preventDefault();
      const username = document.getElementById('register-username').value.trim();
      const password = document.getElementById('register-password').value;

      document.getElementById('register-error').classList.remove('show');
      document.getElementById('register-username-error').classList.remove('show');
      document.getElementById('register-success').classList.remove('show');

      if (allUsers[username]) {
        document.getElementById('register-username-error').classList.add('show');
        return;
      }

      const success = await saveUser(username, password);

      if (success) {
        document.getElementById('register-success').classList.add('show');
        setTimeout(() => {
          currentUser = username;
          localStorage.setItem(SESSION_KEY, currentUser);
          checkAuth();
          closeAuthModal();
        }, 1500);
      } else {
        document.getElementById('register-error').classList.add('show');
      }
    }

    function logout() {
      currentUser = null;
      localStorage.removeItem(SESSION_KEY);
      checkAuth();
    }

    // ===== PROFILE FUNCTIONS =====
    function showProfileModal() {
      document.getElementById('profile-username').textContent = currentUser;
      document.getElementById('profile-avatar').textContent = currentUser.charAt(0).toUpperCase();
      document.getElementById('new-username').value = '';
      document.getElementById('current-password').value = '';
      document.getElementById('new-password').value = '';

      // Clear messages
      document.getElementById('username-change-error').classList.remove('show');
      document.getElementById('username-change-success').classList.remove('show');
      document.getElementById('password-change-error').classList.remove('show');
      document.getElementById('password-change-success').classList.remove('show');

      const modal = document.getElementById('profile-modal-overlay');
      modal.style.display = 'flex';
      requestAnimationFrame(() => {
        modal.classList.add('show');
      });
    }

    function closeProfileModal() {
      const modal = document.getElementById('profile-modal-overlay');
      modal.classList.remove('show');
      setTimeout(() => {
        modal.style.display = 'none';
      }, 300);
    }

    async function handleChangeUsername(e) {
      e.preventDefault();
      const newUsername = document.getElementById('new-username').value.trim();

      document.getElementById('username-change-error').classList.remove('show');
      document.getElementById('username-change-success').classList.remove('show');

      if (newUsername === currentUser) {
        document.getElementById('username-change-error').textContent = 'El nombre es el mismo que el actual';
        document.getElementById('username-change-error').classList.add('show');
        return;
      }

      if (allUsers[newUsername]) {
        document.getElementById('username-change-error').textContent = 'Este nombre de usuario ya está en uso';
        document.getElementById('username-change-error').classList.add('show');
        return;
      }

      try {
        const oldPassword = allUsers[currentUser];

        // Delete old username
        await database.ref('users/' + currentUser).remove();
        delete allUsers[currentUser];

        // Create new username with same password
        await database.ref('users/' + newUsername).set(oldPassword);
        allUsers[newUsername] = oldPassword;

        // Update session
        currentUser = newUsername;
        localStorage.setItem(SESSION_KEY, currentUser);

        document.getElementById('username-change-success').classList.add('show');

        setTimeout(() => {
          checkAuth();
          closeProfileModal();
        }, 1500);
      } catch (error) {
        console.error('Error al cambiar nombre:', error);
        document.getElementById('username-change-error').textContent = 'Error al cambiar el nombre';
        document.getElementById('username-change-error').classList.add('show');
      }
    }

    async function handleChangePassword(e) {
      e.preventDefault();
      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;

      document.getElementById('password-change-error').classList.remove('show');
      document.getElementById('password-change-success').classList.remove('show');

      if (allUsers[currentUser] !== currentPassword) {
        document.getElementById('password-change-error').classList.add('show');
        return;
      }

      try {
        await database.ref('users/' + currentUser).set(newPassword);
        allUsers[currentUser] = newPassword;

        document.getElementById('password-change-success').classList.add('show');
        document.getElementById('current-password').value = '';
        document.getElementById('new-password').value = '';

        setTimeout(() => {
          document.getElementById('password-change-success').classList.remove('show');
        }, 3000);
      } catch (error) {
        console.error('Error al cambiar contraseña:', error);
        document.getElementById('password-change-error').textContent = 'Error al cambiar la contraseña';
        document.getElementById('password-change-error').classList.add('show');
      }
    }

    async function deleteAccount() {
      if (!confirm('¿Estás seguro de que quieres eliminar tu cuenta? Esta acción no se puede deshacer.')) {
        return;
      }

      try {
        await database.ref('users/' + currentUser).remove();
        delete allUsers[currentUser];

        currentUser = null;
        localStorage.removeItem(SESSION_KEY);

        closeProfileModal();
        checkAuth();

        alert('Tu cuenta ha sido eliminada correctamente');
      } catch (error) {
        console.error('Error al eliminar cuenta:', error);
        alert('Error al eliminar la cuenta. Inténtalo de nuevo.');
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      document.body.classList.add("fade-in");
      document.getElementById("year").textContent = new Date().getFullYear();

      await loadUsers();
      hydrateSessionFromStorage();

      // Marca activo
      const path = location.pathname.split("/").pop() || "index.html";
      document.querySelectorAll(".menu a").forEach(a => {
        const href = a.getAttribute("href");
        if ((path === "" && href === "index.html") || href === path) {
          a.setAttribute("aria-current", "page");
        }
      });

      // Transición suave entre páginas internas
      document.querySelectorAll('a[href]').forEach(link => {
        const url = new URL(link.href, location.href);
        if (url.origin === location.origin && !link.target) {
          link.addEventListener("click", e => {
            if (url.pathname === location.pathname && url.hash) return;
            const menu = document.querySelector('.menu');
            if (menu && menu.classList.contains('open')) return;
            e.preventDefault();
            document.body.classList.add("fade-out");
            setTimeout(() => location.href = url.href, 600);
          });
        }
      });

      // Toggle del menú en móvil
      const toggle = document.querySelector('.menu-toggle');
      const menu = document.getElementById('primary-menu');
      function setOpen(open) {
        menu.classList.toggle('open', open);
        toggle.setAttribute('aria-expanded', String(open));
        toggle.setAttribute('aria-label', open ? 'Cerrar menú' : 'Abrir menú');
      }
      toggle.addEventListener('click', () => setOpen(!menu.classList.contains('open')));
      menu.addEventListener('click', (e) => {
        if (e.target.closest('a')) setOpen(false);
      });
      document.addEventListener('click', (e) => {
        if (menu.classList.contains('open')) {
          const within = e.target.closest('.nav-shell');
          if (!within) setOpen(false);
        }
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') setOpen(false);
      });

      // Keyboard support for user-info
      document.querySelector('.user-info')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          showProfileModal();
        }
      });
    });
  </script>
</body>

</html>