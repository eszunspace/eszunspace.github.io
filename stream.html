<!doctype html>
<html lang="es">

<head>
  <meta name="title" content="STREAM – EsZunSpace">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>STREAM – EsZunSpace</title>
  <meta name="description" content="Sigue el lanzamiento en directo.">
  <link rel="canonical" href="https://eszunspace.es/stream.html">
  <meta name="theme-color" content="#0b0b0f">

  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Space+Grotesk:wght@500;700;800&display=swap"
    rel="stylesheet">
  <link rel="icon" type="image/jpeg" href="logoarriba.jpg">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <style>
    :root {
      --bg-image: url('background.jpg');
      --header-h: 64px;
      --primary: #00f0ff;
      --secondary: #ff00d4;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      height: 100%;
      margin: 0;
    }

    body {
      font-family: 'Poppins', system-ui, sans-serif;
      color: #fff;
      background: #000;
      opacity: 0;
      transition: opacity 0.6s ease;
    }

    body.fade-in {
      opacity: 1;
    }

    body.fade-out {
      opacity: 0;
    }

    /* ===== Header ===== */
    header.topbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 2000;
      padding: 12px 12px;
      background: linear-gradient(180deg, rgba(0, 0, 0, .65) 0%, rgba(0, 0, 0, 0) 100%);
      -webkit-backdrop-filter: blur(2px);
      backdrop-filter: blur(2px);
    }

    .nav-shell {
      width: min(1200px, 94vw);
      margin: 0 auto;
      height: var(--header-h);
      padding: 0 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.07), rgba(255, 255, 255, 0.03));
      border: 1px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 10px 30px rgba(0, 0, 0, .6);
      position: relative;
      overflow: hidden;
    }

    .nav-shell::before {
      content: "";
      position: absolute;
      inset: -1px;
      background: conic-gradient(from 0deg, var(--primary), var(--secondary), var(--primary));
      filter: blur(22px);
      opacity: .14;
      pointer-events: none;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      text-decoration: none;
      color: #fff;
      min-width: 0;
    }

    .brand img {
      height: 36px;
      width: 36px;
      border-radius: 50%;
      box-shadow: 0 0 8px rgba(255, 255, 255, .1)
    }

    .brand .title {
      font-family: 'Space Grotesk', system-ui, sans-serif;
      font-weight: 800;
      letter-spacing: .02em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* === Toggle (mobile) === */
    .menu-toggle {
      display: none;
      background: transparent;
      border: 0;
      color: #fff;
      width: 44px;
      height: 44px;
      border-radius: 12px;
    }

    .menu-toggle:focus-visible {
      outline: 2px solid #00f0ff;
      outline-offset: 2px;
    }

    .menu {
      display: flex;
      align-items: center;
      gap: 18px
    }

    .menu a {
      position: relative;
      display: inline-flex;
      align-items: center;
      padding: 10px 10px;
      text-decoration: none;
      color: #fff;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .08em;
      font-size: 12px;
      opacity: .9;
      transition: opacity .2s ease;
      -webkit-tap-highlight-color: transparent;
    }

    .menu a:hover {
      opacity: 1
    }

    .menu a::after {
      content: "";
      position: absolute;
      left: 12px;
      right: 12px;
      bottom: 6px;
      height: 2px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      transform: scaleX(0);
      transform-origin: left;
      transition: transform .25s ease;
      border-radius: 2px;
    }

    .menu a:hover::after,
    .menu a[aria-current="page"]::after {
      transform: scaleX(1);
    }

    .menu a[aria-current="page"] {
      opacity: 1
    }

    /* User section */
    .user-section {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 10px;
      background: rgba(255, 255, 255, .06);
      border: 1px solid rgba(255, 255, 255, .18);
      cursor: pointer;
      transition: transform .15s ease, background .2s ease, border-color .2s ease;
    }

    .user-info:hover {
      transform: translateY(-1px);
      background: rgba(255, 255, 255, .1);
      border-color: rgba(255, 255, 255, .3);
    }

    .user-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: linear-gradient(135deg, #00f0ff, #ff00d4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 12px;
    }

    .user-name {
      font-weight: 600;
      font-size: 13px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 32px;
      min-width: 32px;
      padding: 0 10px;
      border-radius: 10px;
      background: rgba(255, 255, 255, .06);
      border: 1px solid rgba(255, 255, 255, .18);
      color: #fff;
      cursor: pointer;
      user-select: none;
      transition: transform .15s ease, background .2s ease, border-color .2s ease;
      text-decoration: none;
      gap: 8px;
      font-family: inherit;
      font-size: 13px;
    }

    .btn:hover {
      transform: translateY(-1px);
      background: rgba(255, 255, 255, .1);
      border-color: rgba(255, 255, 255, .3)
    }

    .btn.primary {
      border: 0;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      font-weight: 700;
      box-shadow: 0 8px 24px rgba(0, 0, 0, .35);
    }

    .btn.ghost {
      background: rgba(255, 255, 255, .06);
    }

    /* ===== Main Layout ===== */
    .main-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: calc(var(--header-h) + 40px);
      padding-bottom: 40px;
      background-image: var(--bg-image);
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      position: relative;
    }

    .main-container::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 50% 30%, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.85));
      pointer-events: none;
    }

    /* Stream Frame */
    .stream-section {
      position: relative;
      z-index: 10;
      width: min(1100px, 94vw);
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .video-frame {
      position: relative;
      width: 100%;
      aspect-ratio: 16/9;
      border-radius: 24px;
      overflow: hidden;
      box-shadow: 0 0 50px rgba(0, 0, 0, 0.8), 0 0 0 1px rgba(255, 255, 255, 0.1);
      background: #000;
    }

    .video-frame iframe {
      width: 100%;
      height: 100%;
      display: block;
    }

    /* Glow border */
    .video-frame::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 24px;
      box-shadow: inset 0 0 20px rgba(0, 240, 255, 0.1);
      pointer-events: none;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Telemetry Section */
    .telemetry-bar {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      gap: 20px;
      padding: 20px;
      background: rgba(10, 10, 12, 0.85);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      align-items: center;
    }

    .telemetry-group {
      display: flex;
      gap: 24px;
      justify-content: center;
    }

    .telemetry-item {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .telemetry-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 4px;
      font-weight: 600;
    }

    .telemetry-value {
      font-family: 'Space Grotesk', monospace;
      font-size: 24px;
      font-weight: 700;
      color: #fff;
      text-shadow: 0 0 10px rgba(0, 240, 255, 0.3);
    }

    .telemetry-unit {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.4);
      margin-left: 2px;
    }

    /* Countdown Center */
    .countdown-center {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0 30px;
      border-left: 1px solid rgba(255, 255, 255, 0.1);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
    }

    .mission-name {
      font-family: 'Space Grotesk', sans-serif;
      font-weight: 800;
      font-size: 16px;
      background: linear-gradient(90deg, #fff, #ccc);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 4px;
    }

    .countdown-timer {
      font-family: 'Space Grotesk', monospace;
      font-size: 36px;
      font-weight: 700;
      line-height: 1;
      background: linear-gradient(180deg, #fff, #ddd);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
    }

    .mission-status {
      font-size: 12px;
      font-weight: 600;
      color: var(--primary);
      margin-top: 4px;
      letter-spacing: 0.05em;
    }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 18px;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .modal-overlay.show {
      display: flex;
      animation: fadeIn 0.3s ease forwards;
    }

    .modal-card {
      width: min(680px, 96vw);
      border-radius: 18px;
      background: radial-gradient(1200px 1200px at -10% -20%, rgba(0, 240, 255, .08), transparent 35%), #111113;
      border: 1px solid rgba(255, 255, 255, .12);
      box-shadow: 0 28px 80px rgba(0, 0, 0, .6), inset 0 1px 0 rgba(255, 255, 255, .06);
      padding: 18px 18px 16px;
      max-height: 90vh;
      overflow-y: auto;
      transform: scale(0.9) translateY(20px);
      opacity: 0;
      transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease;
    }

    .modal-overlay.show .modal-card {
      transform: scale(1) translateY(0);
      opacity: 1;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .modal-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .modal-title {
      margin: 0;
      font-family: 'Space Grotesk', system-ui, sans-serif;
      font-size: 1.15rem;
      letter-spacing: .2px;
      font-weight: 700;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-top: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .form-group label {
      font-weight: 600;
      font-size: 14px;
    }

    .form-group input {
      padding: 12px 14px;
      border-radius: 10px;
      background: rgba(255, 255, 255, .06);
      border: 1px solid rgba(255, 255, 255, .18);
      color: #fff;
      font-size: 14px;
      font-family: inherit;
      transition: border-color .2s ease, background .2s ease;
    }

    .form-group input:focus {
      outline: none;
      border-color: #00f0ff;
      background: rgba(255, 255, 255, .08);
    }

    .error-msg {
      color: #ff6b6b;
      font-size: 13px;
      margin-top: 4px;
      display: none;
    }

    .error-msg.show {
      display: block;
    }

    .success-msg {
      color: #51cf66;
      font-size: 13px;
      margin-top: 4px;
      display: none;
    }

    .success-msg.show {
      display: block;
    }

    .toggle-form {
      text-align: center;
      margin-top: 16px;
      color: rgba(255, 255, 255, .72);
      font-size: 14px;
    }

    .toggle-form a {
      color: #00f0ff;
      text-decoration: none;
      font-weight: 600;
      transition: opacity .2s ease;
    }

    .toggle-form a:hover {
      opacity: .8
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }

    /* =========================
       Responsive
       ========================= */
    @media (max-width: 900px) {
      :root {
        --header-h: 56px;
      }

      .brand img {
        width: 32px;
        height: 32px;
      }

      .nav-shell {
        padding: 0 10px;
        border-radius: 14px;
      }

      .menu-toggle {
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      .menu {
        position: fixed;
        inset: calc(var(--header-h) + 8px) 8px auto 8px;
        right: 8px;
        left: 8px;
        top: calc(var(--header-h) + 12px);
        display: none;
        flex-direction: column;
        align-items: stretch;
        gap: 6px;
        padding: 10px;
        background: rgba(18, 18, 18, 0.92);
        border: 1px solid rgba(255, 255, 255, 0.12);
        border-radius: 16px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, .6);
        backdrop-filter: blur(8px);
      }

      .menu.open {
        display: flex;
      }

      .menu a {
        padding: 14px 12px;
        font-size: 13px;
        letter-spacing: .12em;
        border-radius: 10px;
      }

      .menu a::after {
        display: none;
      }

      .brand .title {
        font-size: 16px;
      }

      .user-section {
        display: flex;
      }

      .user-section .btn.ghost {
        display: none;
      }

      .user-section #user-display .user-info {
        padding: 4px 8px;
      }

      .user-section #user-display .user-avatar {
        width: 32px;
        height: 32px;
        font-size: 14px;
      }

      .user-section #user-display .user-name {
        display: none;
      }

      .user-section #login-btn {
        padding: 0 12px;
        font-size: 12px;
        height: 36px;
      }

      .telemetry-bar {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .countdown-center {
        border: 0;
        padding: 10px 0;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        order: -1;
      }
    }

    @media (hover:none) {
      .menu a:hover::after {
        transform: none;
      }

      .menu a:hover {
        opacity: 1;
      }
    }

    /* Accesibilidad: respetar reduce-motion */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation: none !important;
        transition: none !important;
      }
    }
  </style>
</head>

<body>

  <header class="topbar">
    <div class="nav-shell">
      <a class="brand" href="index.html" aria-label="Ir a inicio">
        <img src="logoarriba.jpg" alt="Logo de EsZunSpace">
        <span class="title">EsZunSpace</span>
      </a>

      <!-- Toggle sólo visible en móvil -->
      <button class="menu-toggle" aria-controls="primary-menu" aria-expanded="false" aria-label="Abrir menú">
        <svg width="24" height="24" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
          <path d="M3 6h18M3 12h18M3 18h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>
      </button>

      <nav id="primary-menu" class="menu" role="navigation" aria-label="Menú principal">
        <a href="calendario.html">Calendario</a>
        <a href="cohetes.html">Cohetes</a>
        <a href="motores.html">Motores</a>
        <a href="satelites.html">Satélites</a>
        <a href="lanzamientos.html">Lanzamientos</a>
        <a href="stream.html" aria-current="page">Stream</a>
        <div id="mobile-logout-section"
          style="display:none; margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,.12);">
          <button class="btn ghost" onclick="logout()" style="width:100%; justify-content:center;">Cerrar
            sesión</button>
        </div>
      </nav>

      <div class="user-section">
        <div id="user-display" style="display:none;">
          <div class="user-info" onclick="showProfileModal()" role="button" tabindex="0" aria-label="Ver perfil">
            <div class="user-avatar" id="user-avatar">U</div>
            <span class="user-name" id="user-name">Usuario</span>
          </div>
          <button class="btn ghost" onclick="logout()">Salir</button>
        </div>
        <button id="login-btn" class="btn primary" onclick="showLoginModal()">Iniciar sesión</button>
      </div>
    </div>
  </header>

  <main class="main-container">

    <div class="content-grid">

      <div class="stream-section">
        <!-- YouTube Frame -->
        <div class="video-frame">
          <!-- Admin Edit Button (Only visible to Esstor) -->
          <button id="admin-edit-stream" class="btn ghost" onclick="showStreamEditor()"
            style="position:absolute; top:10px; right:10px; z-index:10; display:none;">
            ✏️ Editar Stream
          </button>
          <iframe id="stream-iframe" src="https://www.youtube-nocookie.com/embed/ZA-RB3gltpo?autoplay=1&rel=0"
            title="Live Stream" frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
            allowfullscreen>
          </iframe>
        </div>

        <!-- Telemetry Dashboard -->
        <div class="telemetry-bar">

          <!-- Center: Countdown -->
          <div class="countdown-center">
            <div class="mission-name">EZS-V01</div>
            <div class="countdown-timer" id="timer">T- 00:00:00</div>
            <div class="mission-status">EN ESPERA</div>
          </div>

        </div>
      </div>
    </div>

    <footer>© <span id="year"></span> EsZunSpace – Todos los derechos reservados</footer>
  </main>

  <style>
    /* Layout Grid */
    .content-grid {
      display: flex;
      justify-content: center;
      width: min(1400px, 96vw);
      margin: 0 auto;
    }

    /* Stream Section Adjustments */
    .stream-section {
      width: 100%;
      max-width: 1200px;
    }

    /* Responsive */
    @media (max-width: 900px) {
      .content-grid {
        display: block;
      }
    }

    /* Override/Update telemetry bar for single item */
    .telemetry-bar {
      display: flex;
      justify-content: center;
      padding: 20px;
      background: rgba(10, 10, 12, 0.85);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    .countdown-center {
      border: none;
      /* Remove borders since it's alone */
      padding: 0;
    }
  </style>

  <script>
    // Dynamic Launch Countdown
    (function () {
      const timerEl = document.getElementById('timer');
      const missionNameEl = document.querySelector('.mission-name');
      const missionStatusEl = document.querySelector('.mission-status');

      let currentLaunch = null;
      let allLaunches = [];
      let countdownInterval = null;

      function waitForFirebase() {
        return new Promise((resolve) => {
          if (typeof firebase !== 'undefined' && firebase.database) {
            resolve();
          } else {
            const checkInterval = setInterval(() => {
              if (typeof firebase !== 'undefined' && firebase.database) {
                clearInterval(checkInterval);
                resolve();
              }
            }, 100);
          }
        });
      }

      async function loadLaunches() {
        try {
          await waitForFirebase();
          const db = firebase.database();

          const snapshot = await db.ref('events').once('value');
          const data = snapshot.val() || {};
          allLaunches = Object.keys(data).map(key => ({ id: key, ...data[key] }));

          // Sort by date
          allLaunches.sort((a, b) => new Date(a.datetimeISO) - new Date(b.datetimeISO));

          selectCurrentLaunch();
          startCountdown();
        } catch (error) {
          console.error('Error loading launches:', error);
          missionNameEl.textContent = 'ERROR';
          missionStatusEl.textContent = 'No se pudo cargar lanzamientos';
          timerEl.textContent = 'T- --:--:--';
        }
      }

      function selectCurrentLaunch() {
        const now = new Date();
        const fiveHoursInMs = 5 * 60 * 60 * 1000;

        // Find the "active" launch:
        // - If there's a launch in the past but within T+5h, use that
        // - Otherwise, use the next future launch
        let activeLaunch = null;

        for (const launch of allLaunches) {
          const launchTime = new Date(launch.datetimeISO);
          const timeSinceLaunch = now - launchTime;

          // If launch is in the past but less than 5 hours ago
          if (timeSinceLaunch > 0 && timeSinceLaunch < fiveHoursInMs) {
            activeLaunch = launch;
            break;
          }

          // If launch is in the future
          if (launchTime > now) {
            activeLaunch = launch;
            break;
          }
        }

        currentLaunch = activeLaunch;

        if (currentLaunch) {
          missionNameEl.textContent = currentLaunch.mission || currentLaunch.vehicle || 'Lanzamiento';
          updateStatus();
        } else {
          missionNameEl.textContent = 'SIN LANZAMIENTOS';
          missionStatusEl.textContent = 'ESPERANDO';
          timerEl.textContent = 'T- --:--:--';
        }
      }

      function updateStatus() {
        if (!currentLaunch) return;

        const now = new Date();
        const launchTime = new Date(currentLaunch.datetimeISO);
        const diff = launchTime - now;

        if (diff > 0) {
          missionStatusEl.textContent = 'EN ESPERA';
        } else if (diff > -3600000) { // Within 1 hour after launch
          missionStatusEl.textContent = 'LANZAMIENTO';
        } else {
          missionStatusEl.textContent = 'COMPLETADO';
        }
      }

      function updateCountdown() {
        if (!currentLaunch) {
          timerEl.textContent = 'T- --:--:--';
          return;
        }

        const now = new Date();
        const launchTime = new Date(currentLaunch.datetimeISO);
        const diff = launchTime - now;
        const fiveHoursInMs = 5 * 60 * 60 * 1000;

        // Check if we need to switch to next launch
        if (diff < -fiveHoursInMs) {
          console.log('Launch passed T+5h, switching to next...');
          selectCurrentLaunch();
          return;
        }

        const secondsToLaunch = diff / 1000;
        const absSeconds = Math.abs(secondsToLaunch);
        const hrs = Math.floor(absSeconds / 3600);
        const mins = Math.floor((absSeconds % 3600) / 60);
        const secs = Math.floor(absSeconds % 60);

        const timeString = `${String(hrs).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;

        if (secondsToLaunch > 0) {
          timerEl.textContent = `T- ${timeString}`;
        } else {
          timerEl.textContent = `T+ ${timeString}`;
        }

        updateStatus();
      }

      function startCountdown() {
        if (countdownInterval) {
          clearInterval(countdownInterval);
        }
        updateCountdown();
        countdownInterval = setInterval(updateCountdown, 1000);
      }

      // Load launches when page loads
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadLaunches);
      } else {
        loadLaunches();
      }
    })();
  </script>

  <!-- Login/Register Modal -->
  <div id="auth-modal-overlay" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card" role="document">
      <div class="modal-head">
        <h3 id="auth-modal-title" class="modal-title">Iniciar sesión</h3>
        <button class="btn ghost" onclick="closeAuthModal()" aria-label="Cerrar">✕</button>
      </div>

      <!-- Login Form -->
      <form id="login-form" class="login-form" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label for="login-username">Usuario</label>
          <input type="text" id="login-username" name="username" required autocomplete="username">
        </div>
        <div class="form-group">
          <label for="login-password">Contraseña</label>
          <input type="password" id="login-password" name="password" required autocomplete="current-password">
          <div id="login-error" class="error-msg">Usuario o contraseña incorrectos</div>
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn primary">Entrar</button>
          <button type="button" class="btn ghost" onclick="closeAuthModal()">Cancelar</button>
        </div>
        <div class="toggle-form">
          ¿No tienes cuenta? <a href="#" onclick="showRegisterForm(event)">Crear cuenta</a>
        </div>
      </form>

      <!-- Register Form -->
      <form id="register-form" class="login-form" style="display:none;" onsubmit="handleRegister(event)">
        <div class="form-group">
          <label for="register-username">Usuario</label>
          <input type="text" id="register-username" name="username" required autocomplete="username">
          <div id="register-username-error" class="error-msg">Este nombre de usuario ya está en uso</div>
        </div>
        <div class="form-group">
          <label for="register-password">Contraseña</label>
          <input type="password" id="register-password" name="password" required autocomplete="new-password"
            minlength="6">
          <div id="register-error" class="error-msg">Error al crear la cuenta</div>
          <div id="register-success" class="success-msg">¡Cuenta creada! Iniciando sesión...</div>
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn primary">Crear cuenta</button>
          <button type="button" class="btn ghost" onclick="closeAuthModal()">Cancelar</button>
        </div>
        <div class="toggle-form">
          ¿Ya tienes cuenta? <a href="#" onclick="showLoginForm(event)">Iniciar sesión</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profile-modal-overlay" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card" role="document">
      <div class="modal-head">
        <h3 class="modal-title">Mi Perfil</h3>
        <button class="btn ghost" onclick="closeProfileModal()" aria-label="Cerrar">✕</button>
      </div>

      <div style="margin-top:20px;">
        <div class="user-info" style="justify-content:center; padding:16px; cursor:default;">
          <div class="user-avatar" id="profile-avatar" style="width:48px; height:48px; font-size:20px;">U</div>
          <span class="user-name" id="profile-username" style="font-size:18px;">Usuario</span>
        </div>

        <!-- Change Username Form -->
        <form id="change-username-form" class="login-form" style="margin-top:24px;"
          onsubmit="handleChangeUsername(event)">
          <div class="form-group">
            <label for="new-username">Nuevo nombre de usuario</label>
            <input type="text" id="new-username" name="username" required autocomplete="username">
            <div id="username-change-error" class="error-msg">Este nombre de usuario ya está en uso</div>
            <div id="username-change-success" class="success-msg">¡Nombre de usuario actualizado!</div>
          </div>
          <div class="modal-actions">
            <button type="submit" class="btn primary">Cambiar nombre</button>
          </div>
        </form>

        <!-- Change Password Form -->
        <form id="change-password-form" class="login-form" style="margin-top:16px;"
          onsubmit="handleChangePassword(event)">
          <div class="form-group">
            <label for="current-password">Contraseña actual</label>
            <input type="password" id="current-password" name="current-password" required
              autocomplete="current-password">
          </div>
          <div class="form-group">
            <label for="new-password">Nueva contraseña</label>
            <input type="password" id="new-password" name="new-password" required autocomplete="new-password"
              minlength="6">
            <div id="password-change-error" class="error-msg">Contraseña actual incorrecta</div>
            <div id="password-change-success" class="success-msg">¡Contraseña actualizada!</div>
          </div>
          <div class="modal-actions">
            <button type="submit" class="btn primary">Cambiar contraseña</button>
          </div>
        </form>

        <div style="margin-top:24px; padding-top:16px; border-top:1px solid rgba(255,255,255,.12);">
          <button class="btn ghost" onclick="deleteAccount()" style="color:#ff6b6b; width:100%;">Eliminar
            cuenta</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Stream Editor Modal (Admin Only) -->
  <div id="stream-editor-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card" role="document">
      <div class="modal-head">
        <h3 class="modal-title">Editar Stream URL</h3>
        <button class="btn ghost" onclick="closeStreamEditor()" aria-label="Cerrar">✕</button>
      </div>

      <form id="stream-url-form" class="login-form" style="margin-top:20px;" onsubmit="saveStreamUrl(event)">
        <div class="form-group">
          <label for="stream-url-input">YouTube URL o Video ID</label>
          <input type="text" id="stream-url-input" name="stream-url" required
            placeholder="https://youtube.com/watch?v=... o solo el ID">
          <div style="font-size:12px; color:rgba(255,255,255,0.6); margin-top:4px;">
            Puedes pegar la URL completa o solo el ID del video
          </div>
          <div id="stream-url-error" class="error-msg">Error al guardar URL</div>
          <div id="stream-url-success" class="success-msg">¡URL actualizada correctamente!</div>
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn primary">Guardar</button>
          <button type="button" class="btn ghost" onclick="closeStreamEditor()">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ===== VARIABLES GLOBALES =====
    let currentUser = null;
    let allUsers = {};
    const SESSION_KEY = 'esz_user';
    let database = null;

    // ===== FUNCIONES DE UI (Definidas primero para evitar errores si Firebase falla) =====
    function showLoginModal() {
      console.log('Abriendo modal de login...');
      showLoginForm();
      const modal = document.getElementById('auth-modal-overlay');
      if (modal) {
        modal.style.display = 'flex';
        requestAnimationFrame(() => {
          modal.classList.add('show');
        });
      } else {
        console.error('No se encontró el modal de login');
      }
    }

    function closeAuthModal() {
      const modal = document.getElementById('auth-modal-overlay');
      if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
          modal.style.display = 'none';
        }, 300);
      }
      document.getElementById('login-error')?.classList.remove('show');
      document.getElementById('register-error')?.classList.remove('show');
      document.getElementById('register-username-error')?.classList.remove('show');
      document.getElementById('register-success')?.classList.remove('show');
    }

    function showLoginForm(e) {
      if (e) e.preventDefault();
      const title = document.getElementById('auth-modal-title');
      if (title) title.textContent = 'Iniciar sesión';

      document.getElementById('login-form').style.display = 'flex';
      document.getElementById('register-form').style.display = 'none';
      document.getElementById('login-username').value = '';
      document.getElementById('login-password').value = '';
      document.getElementById('login-error')?.classList.remove('show');
    }

    function showRegisterForm(e) {
      if (e) e.preventDefault();
      const title = document.getElementById('auth-modal-title');
      if (title) title.textContent = 'Crear cuenta';

      document.getElementById('login-form').style.display = 'none';
      document.getElementById('register-form').style.display = 'flex';
      document.getElementById('register-username').value = '';
      document.getElementById('register-password').value = '';
      document.getElementById('register-error')?.classList.remove('show');
      document.getElementById('register-username-error')?.classList.remove('show');
      document.getElementById('register-success')?.classList.remove('show');
    }

    function checkAuth() {
      const loginBtn = document.getElementById('login-btn');
      const userDisplay = document.getElementById('user-display');
      const userName = document.getElementById('user-name');
      const userAvatar = document.getElementById('user-avatar');

      if (!loginBtn || !userDisplay) return;

      if (currentUser) {
        loginBtn.style.display = 'none';
        userDisplay.style.display = 'flex';
        if (userName) userName.textContent = currentUser;
        if (userAvatar) userAvatar.textContent = currentUser.charAt(0).toUpperCase();
      } else {
        loginBtn.style.display = 'inline-flex';
        userDisplay.style.display = 'none';
      }

      // Check admin access whenever auth state changes
      checkAdminAccess();
    }

    function hydrateSessionFromStorage() {
      try {
        const saved = localStorage.getItem(SESSION_KEY);
        currentUser = (saved && saved.trim()) ? saved : null;
        checkAuth();
      } catch (e) {
        console.error('Error accediendo a localStorage', e);
      }
    }

    function logout() {
      currentUser = null;
      localStorage.removeItem(SESSION_KEY);
      checkAuth();
      checkAdminAccess(); // Hide admin button on logout
    }

    // ===== STREAM EDITOR FUNCTIONS (Admin Only) =====
    function checkAdminAccess() {
      const editBtn = document.getElementById('admin-edit-stream');
      if (editBtn && currentUser === 'Esstor') {
        editBtn.style.display = 'inline-flex';
      } else if (editBtn) {
        editBtn.style.display = 'none';
      }
    }

    async function loadStreamUrl() {
      if (!database) return;

      try {
        const snapshot = await database.ref('config/streamUrl').once('value');
        const savedUrl = snapshot.val();

        if (savedUrl) {
          updateIframeUrl(savedUrl);
        }
      } catch (error) {
        console.error('Error loading stream URL:', error);
      }
    }

    function extractVideoId(input) {
      // If it's just a video ID (11 chars alphanumeric with - and _)
      if (/^[a-zA-Z0-9_-]{11}$/.test(input)) {
        return input;
      }

      // Extract from various YouTube URL formats
      const patterns = [
        /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
        /youtube\.com\/live\/([a-zA-Z0-9_-]{11})/
      ];

      for (const pattern of patterns) {
        const match = input.match(pattern);
        if (match) return match[1];
      }

      return null;
    }

    function updateIframeUrl(videoIdOrUrl) {
      const videoId = extractVideoId(videoIdOrUrl);
      if (!videoId) {
        console.error('Invalid YouTube URL or ID');
        return;
      }

      const iframe = document.getElementById('stream-iframe');
      if (iframe) {
        iframe.src = `https://www.youtube-nocookie.com/embed/${videoId}?autoplay=1&rel=0`;
      }
    }

    function showStreamEditor() {
      if (currentUser !== 'Esstor') {
        alert('Solo el administrador puede editar el stream');
        return;
      }

      const modal = document.getElementById('stream-editor-modal');
      const input = document.getElementById('stream-url-input');

      // Clear previous messages
      document.getElementById('stream-url-error').classList.remove('show');
      document.getElementById('stream-url-success').classList.remove('show');

      // Pre-fill with current iframe src if possible
      const iframe = document.getElementById('stream-iframe');
      if (iframe) {
        const match = iframe.src.match(/embed\/([a-zA-Z0-9_-]{11})/);
        if (match) input.value = match[1];
      }

      modal.style.display = 'flex';
      requestAnimationFrame(() => {
        modal.classList.add('show');
      });
    }

    function closeStreamEditor() {
      const modal = document.getElementById('stream-editor-modal');
      modal.classList.remove('show');
      setTimeout(() => {
        modal.style.display = 'none';
      }, 300);
    }

    async function saveStreamUrl(e) {
      e.preventDefault();

      console.log('saveStreamUrl called, currentUser:', currentUser);
      console.log('database initialized:', !!database);

      if (currentUser !== 'Esstor') {
        alert('Solo el usuario Esstor puede editar el stream');
        return;
      }

      if (!database) {
        alert('Error: Firebase no está inicializado');
        return;
      }

      const input = document.getElementById('stream-url-input').value.trim();
      console.log('Input URL:', input);

      const videoId = extractVideoId(input);
      console.log('Extracted video ID:', videoId);

      document.getElementById('stream-url-error').classList.remove('show');
      document.getElementById('stream-url-success').classList.remove('show');

      if (!videoId) {
        document.getElementById('stream-url-error').textContent = 'URL o ID de YouTube inválido';
        document.getElementById('stream-url-error').classList.add('show');
        return;
      }

      try {
        console.log('Attempting to save to Firebase...');
        // Save to Firebase
        await database.ref('config/streamUrl').set(videoId);
        console.log('Successfully saved to Firebase');

        // Update iframe
        updateIframeUrl(videoId);

        // Show success
        document.getElementById('stream-url-success').classList.add('show');

        // Close modal after 1.5s
        setTimeout(() => {
          closeStreamEditor();
        }, 1500);
      } catch (error) {
        console.error('Error saving stream URL:', error);
        console.error('Error details:', error.message, error.code);
        document.getElementById('stream-url-error').textContent = 'Error al guardar la URL: ' + (error.message || 'Error desconocido');
        document.getElementById('stream-url-error').classList.add('show');
      }
    }


    // ===== PROFILE FUNCTIONS =====
    function showProfileModal() {
      if (!currentUser) return;

      const pName = document.getElementById('profile-username');
      const pAvatar = document.getElementById('profile-avatar');

      if (pName) pName.textContent = currentUser;
      if (pAvatar) pAvatar.textContent = currentUser.charAt(0).toUpperCase();

      document.getElementById('new-username').value = '';
      document.getElementById('current-password').value = '';
      document.getElementById('new-password').value = '';

      // Clear messages
      document.getElementById('username-change-error')?.classList.remove('show');
      document.getElementById('username-change-success')?.classList.remove('show');
      document.getElementById('password-change-error')?.classList.remove('show');
      document.getElementById('password-change-success')?.classList.remove('show');

      const modal = document.getElementById('profile-modal-overlay');
      if (modal) {
        modal.style.display = 'flex';
        requestAnimationFrame(() => {
          modal.classList.add('show');
        });
      }
    }

    function closeProfileModal() {
      const modal = document.getElementById('profile-modal-overlay');
      if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
          modal.style.display = 'none';
        }, 300);
      }
    }

    // ===== CONFIGURACIÓN DE FIREBASE =====
    const firebaseConfig = {
      apiKey: "AIzaSyDKvGLsd1jKfsSlzgTjBas-8WvbFqV1xU",
      authDomain: "eszunspace-bc900.firebaseapp.com",
      databaseURL: "https://eszunspace-bc900-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "eszunspace-bc900",
      storageBucket: "eszunspace-bc900.firebasestorage.app",
      messagingSenderId: "105651684829",
      appId: "1:105651684829:web:5c8fd5051c8c2daf24f744",
      measurementId: "G-ZDM5GF0MBW"
    };

    try {
      if (typeof firebase !== 'undefined') {
        firebase.initializeApp(firebaseConfig);
        database = firebase.database();
        console.log('Firebase inicializado correctamente');
      } else {
        console.error('Firebase SDK no cargado');
      }
    } catch (e) {
      console.error('Error inicializando Firebase:', e);
    }

    // ===== ASYNC FUNCTIONS (Dependen de Firebase) =====
    async function loadUsers() {
      if (!database) return;
      try {
        const snapshot = await database.ref('users').once('value');
        allUsers = snapshot.val() || {};
      } catch (error) {
        console.error('Error al cargar usuarios:', error);
        allUsers = {};
      }
    }

    async function saveUser(username, password) {
      if (!database) {
        alert('Error de conexión con la base de datos');
        return false;
      }
      try {
        const snapshot = await database.ref('users/' + username).once('value');
        if (snapshot.exists()) {
          return false;
        }
        await database.ref('users/' + username).set(password);
        allUsers[username] = password;
        return true;
      } catch (error) {
        console.error('Error al guardar usuario:', error);
        return false;
      }
    }

    async function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('login-username').value.trim();
      const password = document.getElementById('login-password').value;

      if (allUsers[username] && allUsers[username] === password) {
        currentUser = username;
        localStorage.setItem(SESSION_KEY, currentUser);
        checkAuth();
        closeAuthModal();
      } else {
        document.getElementById('login-error').classList.add('show');
      }
    }

    async function handleRegister(e) {
      e.preventDefault();
      const username = document.getElementById('register-username').value.trim();
      const password = document.getElementById('register-password').value;

      document.getElementById('register-error').classList.remove('show');
      document.getElementById('register-username-error').classList.remove('show');
      document.getElementById('register-success').classList.remove('show');

      if (allUsers[username]) {
        document.getElementById('register-username-error').classList.add('show');
        return;
      }

      const saved = await saveUser(username, password);

      if (saved) {
        document.getElementById('register-success').classList.add('show');
        setTimeout(() => {
          currentUser = username;
          localStorage.setItem(SESSION_KEY, currentUser);
          checkAuth();
          closeAuthModal();
        }, 1500);
      } else {
        document.getElementById('register-error').classList.add('show');
      }
    }

    async function handleChangeUsername(e) {
      e.preventDefault();
      if (!database) return;

      const newUsername = document.getElementById('new-username').value.trim();

      document.getElementById('username-change-error').classList.remove('show');
      document.getElementById('username-change-success').classList.remove('show');

      if (newUsername === currentUser) {
        document.getElementById('username-change-error').textContent = 'El nombre es el mismo que el actual';
        document.getElementById('username-change-error').classList.add('show');
        return;
      }

      if (allUsers[newUsername]) {
        document.getElementById('username-change-error').textContent = 'Este nombre de usuario ya está en uso';
        document.getElementById('username-change-error').classList.add('show');
        return;
      }

      try {
        const oldPassword = allUsers[currentUser];

        // Delete old username
        await database.ref('users/' + currentUser).remove();
        delete allUsers[currentUser];

        // Create new username with same password
        await database.ref('users/' + newUsername).set(oldPassword);
        allUsers[newUsername] = oldPassword;

        // Update session
        currentUser = newUsername;
        localStorage.setItem(SESSION_KEY, currentUser);

        document.getElementById('username-change-success').classList.add('show');

        setTimeout(() => {
          checkAuth();
          closeProfileModal();
        }, 1500);
      } catch (error) {
        console.error('Error al cambiar nombre:', error);
        document.getElementById('username-change-error').textContent = 'Error al cambiar el nombre';
        document.getElementById('username-change-error').classList.add('show');
      }
    }

    async function handleChangePassword(e) {
      e.preventDefault();
      if (!database) return;

      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;

      document.getElementById('password-change-error').classList.remove('show');
      document.getElementById('password-change-success').classList.remove('show');

      if (allUsers[currentUser] !== currentPassword) {
        document.getElementById('password-change-error').classList.add('show');
        return;
      }

      try {
        await database.ref('users/' + currentUser).set(newPassword);
        allUsers[currentUser] = newPassword;

        document.getElementById('password-change-success').classList.add('show');
        document.getElementById('current-password').value = '';
        document.getElementById('new-password').value = '';

        setTimeout(() => {
          document.getElementById('password-change-success').classList.remove('show');
        }, 3000);
      } catch (error) {
        console.error('Error al cambiar contraseña:', error);
        document.getElementById('password-change-error').textContent = 'Error al cambiar la contraseña';
        document.getElementById('password-change-error').classList.add('show');
      }
    }

    async function deleteAccount() {
      if (!database) return;

      if (!confirm('¿Estás seguro de que quieres eliminar tu cuenta? Esta acción no se puede deshacer.')) {
        return;
      }

      try {
        await database.ref('users/' + currentUser).remove();
        delete allUsers[currentUser];

        currentUser = null;
        localStorage.removeItem(SESSION_KEY);

        closeProfileModal();
        checkAuth();

        alert('Tu cuenta ha sido eliminada correctamente');
      } catch (error) {
        console.error('Error al eliminar cuenta:', error);
        alert('Error al eliminar la cuenta. Inténtalo de nuevo.');
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      document.body.classList.add("fade-in");
      document.getElementById("year").textContent = new Date().getFullYear();

      await loadUsers();
      hydrateSessionFromStorage();

      // Load stream URL from Firebase
      await loadStreamUrl();

      // Check if user is admin (Esstor)
      checkAdminAccess();

      // Marca activo
      const path = location.pathname.split("/").pop() || "index.html";
      document.querySelectorAll(".menu a").forEach(a => {
        const href = a.getAttribute("href");
        if ((path === "" && href === "index.html") || href === path) {
          a.setAttribute("aria-current", "page");
        }
      });

      // Transición suave entre páginas internas
      document.querySelectorAll('a[href]').forEach(link => {
        const url = new URL(link.href, location.href);
        if (url.origin === location.origin && !link.target) {
          link.addEventListener("click", e => {
            if (url.pathname === location.pathname && url.hash) return;
            const menu = document.querySelector('.menu');
            if (menu && menu.classList.contains('open')) return;
            e.preventDefault();
            document.body.classList.add("fade-out");
            setTimeout(() => location.href = url.href, 600);
          });
        }
      });

      // Toggle del menú en móvil
      const toggle = document.querySelector('.menu-toggle');
      const menu = document.getElementById('primary-menu');
      function setOpen(open) {
        menu.classList.toggle('open', open);
        toggle.setAttribute('aria-expanded', String(open));
        toggle.setAttribute('aria-label', open ? 'Cerrar menú' : 'Abrir menú');
      }
      toggle.addEventListener('click', () => setOpen(!menu.classList.contains('open')));
      menu.addEventListener('click', (e) => {
        if (e.target.closest('a')) setOpen(false);
      });
      document.addEventListener('click', (e) => {
        if (menu.classList.contains('open')) {
          const within = e.target.closest('.nav-shell');
          if (!within) setOpen(false);
        }
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') setOpen(false);
      });

      // Keyboard support for user-info
      document.querySelector('.user-info')?.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          showProfileModal();
        }
      });
    });
  </script>

</body>

</html>